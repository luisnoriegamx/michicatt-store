<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MichiCatt Store</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de jsPDF para generar PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Carga de AutoTable para jsPDF (para tablas) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Configuración de Tailwind y Estilos Personalizados -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pink-primary': '#F472B6', // Rosa principal
                        'pink-secondary': '#EC4899', // Rosa más oscuro
                        'pink-light': '#FBCFE8', // Rosa claro
                        'pink-dark': '#831843', // Rosa muy oscuro (para texto)
                        'pink-bg': '#FFF1F2', // Fondo rosa muy pálido
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Fondo con huellitas de gatito */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cpath d='M25 10 C20 10, 10 20, 10 25 C10 30, 20 40, 25 40 C30 40, 40 30, 40 25 C40 20, 30 10, 25 10 Z M60 15 C55 15, 45 25, 45 30 C45 35, 55 45, 60 45 C65 45, 75 35, 75 30 C75 25, 65 15, 60 15 Z M85 20 C80 20, 70 30, 70 35 C70 40, 80 50, 85 50 C90 50, 100 40, 100 35 C100 30, 90 20, 85 20 Z M40 50 C30 50, 20 65, 20 75 C20 85, 30 95, 40 95 C50 95, 60 85, 60 75 C60 65, 50 50, 40 50 Z' fill='%23FBCFE8' opacity='0.2' transform='rotate(30 50 50)'/%3E%3C/svg%3E");
            background-repeat: repeat;
            background-size: 150px 150px;
            z-index: -1;
            opacity: 0.5;
        }
        /* Estilo para la barra de scroll de navegación */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none; /* IE y Edge */
            scrollbar-width: none; /* Firefox */
        }
        /* Efecto de pulsación para botones */
        .btn-pulse:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 15px 0 rgba(236, 72, 153, 0.3);
        }
        .btn-pulse:active {
            transform: scale(0.98);
        }
        /* Estilo para items clickables en catálogo */
        .catalog-item {
            transition: all 0.2s;
        }
        .catalog-item:hover {
            background-color: #FFF1F2; /* pink-bg */
            transform: translateX(4px);
        }
    </style>
</head>
<body class="bg-pink-bg text-pink-dark font-sans relative min-h-screen overflow-x-hidden">

    <!-- Pantalla de Login -->
    <div id="loginScreen" class="fixed inset-0 z-50 flex items-center justify-center bg-pink-primary p-4">
        <div class="bg-white w-full max-w-sm p-8 rounded-2xl shadow-2xl text-center">
            <h1 class="text-3xl font-bold text-pink-secondary mb-2">MichiCatt Store</h1>
            <p class="text-pink-dark mb-6">Panel de Administración</p>
            <form id="loginForm">
                <div class="mb-4 text-left">
                    <label for="username" class="block text-sm font-medium text-pink-dark mb-1">Usuario</label>
                    <input type="text" id="username" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary focus:border-transparent outline-none" required>
                </div>
                <div class="mb-6 text-left">
                    <label for="password" class="block text-sm font-medium text-pink-dark mb-1">Contraseña</label>
                    <input type="password" id="password" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary focus:border-transparent outline-none" required>
                </div>
                <p id="loginError" class="text-red-500 text-sm mb-4 hidden">Usuario o contraseña incorrectos.</p>
                <button type="submit" class="w-full bg-pink-primary text-white py-2 px-4 rounded-lg font-semibold shadow-lg hover:bg-pink-secondary transition-all duration-300 btn-pulse">
                    Entrar
                </button>
            </form>
        </div>
    </div>

    <!-- Contenido Principal de la App (Oculto por defecto) -->
    <div id="appContainer" class="hidden">
        
        <!-- Cabecera -->
        <header class="bg-white shadow-md p-4 sticky top-0 z-40">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-xl sm:text-2xl font-bold text-pink-secondary">MichiCatt Store</h1>
                <span id="welcomeUser" class="text-sm text-pink-dark font-medium"></span>
            </div>
        </header>

        <!-- Navegación por Pestañas (¡SIMPLIFICADA!) -->
        <nav class="bg-white shadow-sm sticky top-[68px] sm:top-[76px] z-30">
            <div class="container mx-auto px-4">
                <div class="flex border-b border-pink-100 overflow-x-auto no-scrollbar">
                    <button data-tab="cotizador" class="tab-button active-tab flex-shrink-0 text-pink-secondary border-b-2 border-pink-primary py-3 px-4 font-medium">
                        Cotizador
                    </button>
                    <button data-tab="productos" class="tab-button flex-shrink-0 text-pink-dark/70 hover:text-pink-primary py-3 px-4 font-medium">
                        Productos
                    </button>
                    <button data-tab="pedidos" class="tab-button flex-shrink-0 text-pink-dark/70 hover:text-pink-primary py-3 px-4 font-medium">
                        Pedidos Guardados
                    </button>
                </div>
            </div>
        </nav>

        <!-- Contenedor de Pestañas -->
        <main class="container mx-auto p-4 md:p-6">
            
            <!-- Pestaña: Cotizador (¡NUEVA!) -->
            <div id="cotizador" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    <!-- Columna 1: Mi Catálogo -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold text-pink-secondary mb-4">Mi Catálogo</h2>
                        <input type="text" id="quoteProductSearch" class="w-full px-4 py-2 border border-pink-light rounded-lg mb-4" placeholder="Buscar producto...">
                        <div id="quoteCatalogList" class="max-h-96 overflow-y-auto pr-2 space-y-2">
                            <!-- Lista de productos del catálogo se cargará aquí -->
                            <p id="noCatalogProducts" class="text-pink-dark/60">Agrega productos en la pestaña 'Productos'.</p>
                        </div>
                    </div>

                    <!-- Columna 2: Nuevo Pedido -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg space-y-4">
                        <h2 class="text-2xl font-bold text-pink-secondary">Nuevo Pedido</h2>
                        
                        <!-- Formulario de Pedido -->
                        <form id="newOrderForm">
                            <div>
                                <label for="orderClientName" class="block text-sm font-medium text-pink-dark mb-1">Nombre del Cliente (Manual)</label>
                                <input type="text" id="orderClientName" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none" required>
                            </div>
                            <div>
                                <label for="orderKm" class="block text-sm font-medium text-pink-dark mb-1">Envío (Kilómetros)</label>
                                <input type="number" id="orderKm" value="0" min="0" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none" required>
                            </div>
                        </form>
                        
                        <!-- Carrito de Pedido -->
                        <h3 class="text-lg font-semibold text-pink-dark pt-2">Carrito de Pedido</h3>
                        <div id="orderCartItems" class="mb-4 max-h-60 overflow-y-auto pr-2 space-y-2">
                            <!-- Los artículos del carrito se agregarán aquí -->
                            <p id="emptyCart" class="text-pink-dark/60">Agrega productos desde el catálogo.</p>
                        </div>
                        
                        <!-- Resumen de Costos -->
                        <div class="bg-pink-bg p-4 rounded-lg space-y-2">
                            <h4 class="text-lg font-bold text-pink-dark">Resumen del Pedido</h4>
                            <div class="flex justify-between">
                                <span class="text-pink-dark">Subtotal Productos:</span>
                                <span id="orderSubtotal" class="font-semibold text-pink-dark">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-pink-dark">Costo de Envío:</span>
                                <span id="orderShipping" class="font-semibold text-pink-dark">$0.00</span>
                            </div>
                            <div class="flex justify-between text-xl font-bold text-pink-secondary pt-2 border-t border-pink-light">
                                <span>Total:</span>
                                <span id="orderTotal">$0.00</span>
                            </div>
                        </div>
                        
                        <!-- Botones de Acción -->
                        <div class="flex gap-4">
                            <button type="button" id="clearOrderBtn" class="w-1/2 bg-gray-300 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-400 transition-all duration-300">
                                Limpiar
                            </button>
                            <button type="button" id="saveOrderBtn" class="w-1/2 bg-green-500 text-white py-2 px-4 rounded-lg font-semibold shadow-lg hover:bg-green-600 transition-all duration-300 btn-pulse">
                                Guardar Pedido
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pestaña: Productos (¡NUEVA!) -->
            <div id="productos" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Columna 1: Agregar Producto (¡NUEVO!) -->
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h2 class="text-2xl font-bold text-pink-secondary mb-6">Agregar Producto</h2>
                            <form id="addProductForm">
                                <div class="mb-4">
                                    <label for="productName" class="block text-sm font-medium text-pink-dark mb-1">Nombre del Producto</label>
                                    <input type="text" id="productName" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none" required>
                                </div>
                                <div class="mb-4">
                                    <label for="productCost" class="block text-sm font-medium text-pink-dark mb-1">Costo Real (Cuánto te costó)</label>
                                    <input type="number" id="productCost" min="0" step="0.01" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none" required>
                                </div>
                                <div class="mb-4">
                                    <label for="productMargin" class="block text-sm font-medium text-pink-dark mb-1">% de Ganancia (ej. 50)</label>
                                    <input type="number" id="productMargin" min="0" max="99.99" step="0.01" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none" required>
                                </div>
                                <!-- Precio al Cliente (Solo Lectura) -->
                                <div class="mb-6">
                                    <label for="productPricePublic" class="block text-sm font-medium text-pink-dark mb-1">Precio al Cliente (Calculado)</label>
                                    <input type="text" id="productPricePublic" class="w-full px-4 py-2 border border-pink-light rounded-lg bg-pink-bg text-pink-dark font-bold outline-none" readonly>
                                </div>
                                <button type="submit" class="w-full bg-pink-primary text-white py-2 px-4 rounded-lg font-semibold shadow-lg hover:bg-pink-secondary transition-all duration-300 btn-pulse">
                                    Guardar Producto
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Columna 2 y 3: Mi Catálogo -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold text-pink-secondary mb-4">Mi Catálogo de Productos</h2>
                        <input type="text" id="adminProductSearch" class="w-full px-4 py-2 border border-pink-light rounded-lg mb-4" placeholder="Buscar producto...">
                        <div id="productsList" class="space-y-3 max-h-[600px] overflow-y-auto pr-2">
                            <!-- Lista de productos se cargará aquí -->
                            <p id="noProducts" class="col-span-full text-pink-dark/60">No hay productos guardados.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pestaña: Pedidos Guardados (¡NUEVA!) -->
            <div id="pedidos" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-pink-secondary mb-6">Pedidos Guardados</h2>
                <div id="ordersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Los pedidos guardados se cargarán aquí -->
                    <p id="noOrders" class="col-span-full text-pink-dark/60">No hay pedidos guardados.</p>
                </div>
            </div>
            
        </main>
    </div>

    <!-- Notificación Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-xl opacity-0 transform translate-y-10 transition-all duration-500 z-50">
        ¡Guardado correctamente!
    </div>

    <!-- ================================================================== -->
    <!-- Carga de Firebase y Lógica de la App -->
    <!-- ================================================================== -->
    
    <!-- Importar Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            addDoc, 
            collection, 
            onSnapshot,
            query,
            getDoc,
            deleteDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ------------------------------------------------------------------
        // CONFIGURACIÓN DE FIREBASE (¡YA ESTÁ LISTA!)
        // ------------------------------------------------------------------
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyD7XyxOW8rWjptvHt4u6ebf-9FZj4otA5Q",
          authDomain: "michicatt-store.firebaseapp.com",
          projectId: "michicatt-store",
          storageBucket: "michicatt-store.firebasestorage.app",
          messagingSenderId: "742378744678",
          appId: "1:742378744678:web:8fdac890199575d414f6a7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('Debug'); // Activar logs de Firestore

        // ------------------------------------------------------------------
        // Variables Globales y Estado de la App
        // ------------------------------------------------------------------
        
        // Referencias a elementos del DOM
        const loginScreen = document.getElementById('loginScreen');
        const appContainer = document.getElementById('appContainer');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const welcomeUser = document.getElementById('welcomeUser');
        const toast = document.getElementById('toast');
        
        // Pestañas
        const tabs = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        // Formularios
        const addProductForm = document.getElementById('addProductForm');
        const newOrderForm = document.getElementById('newOrderForm'); // Cotizador

        // Botones
        const saveOrderBtn = document.getElementById('saveOrderBtn');
        const clearOrderBtn = document.getElementById('clearOrderBtn');

        // Listas
        const productsList = document.getElementById('productsList'); // Admin
        const ordersList = document.getElementById('ordersList');
        const quoteCatalogList = document.getElementById('quoteCatalogList'); // Cotizador
        const orderCartItems = document.getElementById('orderCartItems');

        // IDs
        const noProducts = document.getElementById('noProducts');
        const noOrders = document.getElementById('noOrders');
        const emptyCart = document.getElementById('emptyCart');
        const noCatalogProducts = document.getElementById('noCatalogProducts');

        // Búsqueda
        const adminProductSearch = document.getElementById('adminProductSearch');
        const quoteProductSearch = document.getElementById('quoteProductSearch');
        
        // Inputs Formulario Productos
        const productCostInput = document.getElementById('productCost');
        const productMarginInput = document.getElementById('productMargin');
        const productPricePublicOutput = document.getElementById('productPricePublic');

        // Inputs Formulario Pedido
        const orderKmInput = document.getElementById('orderKm');

        // Estado de la App
        let userId = null;
        const COSTO_POR_KM = 23.99 / 7; // $3.427...
        let productsData = []; // Caché local de productos
        let orderCart = []; // Carrito de pedido

        // Referencias a Colecciones de Firestore
        let productCollectionRef;
        let ordersCollectionRef;

        // ------------------------------------------------------------------
        // Lógica de Autenticación y Login
        // ------------------------------------------------------------------

        // Observador de estado de autenticación
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Usuario autenticado anónimamente:", user.uid);
            } else {
                console.log("Usuario no autenticado.");
            }
        });

        // Login Falso (Simulado)
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;

            if (user === 'Michicatt' && pass === 'Strawberry') {
                try {
                    // Autenticar anónimamente en Firebase
                    const userCredential = await signInAnonymously(auth);
                    
                    // Mostrar App y ocultar Login
                    welcomeUser.textContent = `¡Hola, ${user}!`;
                    loginScreen.classList.add('hidden');
                    appContainer.classList.remove('hidden');

                    // Iniciar la aplicación
                    initializeAppLocal(userCredential.user.uid); 

                } catch (error) {
                    console.error("Error al iniciar sesión anónimo en Firebase:", error);
                    loginError.textContent = "Error de conexión con Firebase.";
                    loginError.classList.remove('hidden');
                }
            } else {
                loginError.textContent = "Usuario o contraseña incorrectos.";
                loginError.classList.remove('hidden');
            }
        });

        // ------------------------------------------------------------------
        // Inicialización de la App
        // ------------------------------------------------------------------
        
        function initializeAppLocal(uid) {
            if (!uid) {
                console.error("¡Fallo de inicialización! No hay UID.");
                return;
            }
            userId = uid;
            
            initFirestoreRefs();
            initEventListeners();
            initDataListeners();
        }

        // ------------------------------------------------------------------
        // Inicialización de Firestore
        // ------------------------------------------------------------------
        
        function initFirestoreRefs() {
            if (!userId) return;
            // Rutas privadas del usuario
            productCollectionRef = collection(db, 'users', userId, 'products');
            ordersCollectionRef = collection(db, 'users', userId, 'orders');
        }
        
        // ------------------------------------------------------------------
        // Lógica de Pestañas
        // ------------------------------------------------------------------
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Quitar clase activa de todos
                tabs.forEach(t => {
                    t.classList.remove('active-tab', 'text-pink-secondary', 'border-pink-primary');
                    t.classList.add('text-pink-dark/70', 'hover:text-pink-primary');
                });
                // Ocultar todo el contenido
                tabContents.forEach(c => c.classList.add('hidden'));

                // Activar la pestaña clicada
                tab.classList.add('active-tab', 'text-pink-secondary', 'border-pink-primary');
                tab.classList.remove('text-pink-dark/70', 'hover:text-pink-primary');
                // Mostrar el contenido correspondiente
                document.getElementById(tab.dataset.tab).classList.remove('hidden');
            });
        });

        // ------------------------------------------------------------------
        // Lógica de Toast (Notificación)
        // ------------------------------------------------------------------
        
        function showToast(message, isError = false) {
            toast.textContent = message;
            if (isError) {
                toast.classList.remove('bg-green-500');
                toast.classList.add('bg-red-500');
            } else {
                toast.classList.remove('bg-red-500');
                toast.classList.add('bg-green-500');
            }
            
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-10');
            }, 3000);
        }

        // ------------------------------------------------------------------
        // Lógica de Formateo
        // ------------------------------------------------------------------
        
        const formatCurrency = (value) => {
            return (value || 0).toLocaleString('es-MX', {
                style: 'currency',
                currency: 'MXN',
            });
        };

        // ------------------------------------------------------------------
        // Listeners de Eventos
        // ------------------------------------------------------------------

        function initEventListeners() {
            // Formularios
            addProductForm.addEventListener('submit', onSaveProduct);
            
            // Botones
            saveOrderBtn.addEventListener('click', onSaveOrder);
            clearOrderBtn.addEventListener('click', clearOrder);

            // Búsqueda
            adminProductSearch.addEventListener('input', renderAdminProductsList);
            quoteProductSearch.addEventListener('input', renderQuoteCatalogList);
            
            // Clics en listas (Delegación de eventos)
            document.addEventListener('click', handleDocumentClick);

            // Calculadora de Precio de Producto (¡CORREGIDA!)
            productCostInput.addEventListener('input', updateCalculatedPrice);
            productMarginInput.addEventListener('input', updateCalculatedPrice);
            
            // Calculadora de Envío (¡NUEVO!)
            orderKmInput.addEventListener('input', updateOrderSummary);
        }

        // ------------------------------------------------------------------
        // Listeners de Datos (Firestore)
        // ------------------------------------------------------------------

        // Iniciar todos los listeners de Firestore
        function initDataListeners() {
            if (!userId) return;

            // Listener de Productos
            onSnapshot(query(productCollectionRef), (snapshot) => {
                productsData = [];
                
                if (snapshot.empty) {
                    noProducts.classList.remove('hidden');
                    noCatalogProducts.classList.remove('hidden');
                    productsList.innerHTML = '';
                    quoteCatalogList.innerHTML = '';
                } else {
                    noProducts.classList.add('hidden');
                    noCatalogProducts.classList.add('hidden');
                    snapshot.forEach(doc => {
                        productsData.push({ ...doc.data(), id: doc.id });
                    });
                    // Ordenar productos alfabéticamente
                    productsData.sort((a, b) => a.name.localeCompare(b.name));
                    
                    // Renderizar ambas listas
                    renderAdminProductsList();
                    renderQuoteCatalogList();
                }
            });

            // Listener de Pedidos Guardados
            onSnapshot(query(ordersCollectionRef), (snapshot) => {
                if (snapshot.empty) {
                    noOrders.classList.remove('hidden');
                    ordersList.innerHTML = '';
                } else {
                    noOrders.classList.add('hidden');
                    const orderItems = [];
                    snapshot.forEach(doc => {
                        const order = { ...doc.data(), id: doc.id };
                        orderItems.push(renderOrderCard(order));
                    });
                    ordersList.innerHTML = orderItems.join('');
                }
            });
        }
        
        // ------------------------------------------------------------------
        // Manejador Global de Clics
        // ------------------------------------------------------------------
        
        async function handleDocumentClick(e) {
            // Clic en un producto del catálogo en Cotizador (¡NUEVO!)
            if (e.target.closest('.add-to-cart-btn')) {
                const item = e.target.closest('div[data-id]');
                const id = item.dataset.id;
                const product = productsData.find(p => p.id === id);
                if (product) {
                    addProductToCart(product);
                }
                return;
            }

            // Quitar item del carrito (¡NUEVO!)
            if (e.target.classList.contains('remove-cart-item')) {
                const item = e.target.closest('div[data-index]');
                if (item) {
                    const index = parseInt(item.dataset.index); 
                    orderCart.splice(index, 1);
                    renderOrderCart();
                    updateOrderSummary();
                }
                return;
            }

            // Borrar producto (Admin)
            if (e.target.classList.contains('delete-product')) {
                const item = e.target.closest('div[data-id]');
                const id = item.dataset.id;
                if (confirm("¿Estás segura de que quieres borrar este producto?")) {
                    try {
                        await deleteDoc(doc(db, 'users', userId, 'products', id));
                        showToast("Producto eliminado");
                    } catch (error) {
                        console.error("Error al borrar producto:", error);
                        showToast("Error al borrar producto", true);
                    }
                }
                return;
            }

            // Acciones de Pedido (PDF)
            const orderCard = e.target.closest('#ordersList div[data-id]');
            if (orderCard) {
                const orderId = orderCard.dataset.id;
                if (e.target.classList.contains('download-order-pdf')) {
                    try {
                        const docSnap = await getDoc(doc(db, 'users', userId, 'orders', orderId));
                        if (docSnap.exists()) generateOrderPDF(docSnap.data());
                    } catch (error) { showToast("Error al generar PDF", true); }
                }
                return;
            }
        }

        // ------------------------------------------------------------------
        // Lógica de Pestaña PRODUCTOS (¡CORREGIDA!)
        // ------------------------------------------------------------------

        // --- Calcular Precio en Tiempo Real ---
        function updateCalculatedPrice() {
            const cost = parseFloat(productCostInput.value) || 0;
            const marginPercent = parseFloat(productMarginInput.value) || 0; // Es el % ej. 50

            if (cost === 0) {
                productPricePublicOutput.value = formatCurrency(0);
                return;
            }

            // ¡Validación importante! Un margen de 100% o más resultaría en un precio infinito
            if (marginPercent >= 100) {
                productPricePublicOutput.value = "Error: Margen >= 100%";
                return;
            }
            
            const margin = marginPercent / 100; // Convertir 50 a 0.5
            
            // FÓRMULA DE MARGEN (Ganancia sobre Precio) - ¡CORREGIDA!
            // Precio = Costo / (1 - %Ganancia)
            const price = cost / (1 - margin); 
            
            productPricePublicOutput.value = formatCurrency(price);
        }

        // --- Guardar Producto ---
        async function onSaveProduct(e) {
            e.preventDefault();
            const name = document.getElementById('productName').value;
            const cost = parseFloat(productCostInput.value);
            const marginPercent = parseFloat(productMarginInput.value); // Renombrado para claridad

            if (isNaN(cost) || isNaN(marginPercent)) {
                showToast("Costo y Margen deben ser números", true);
                return;
            }
            
            if (marginPercent >= 100) {
                showToast("El margen no puede ser 100% o más", true);
                return;
            }

            const margin = marginPercent / 100; // Convertir 50 a 0.5
            
            // FÓRMULA DE MARGEN (Ganancia sobre Precio) - ¡CORREGIDA!
            const price = cost / (1 - margin); 

            try {
                await addDoc(productCollectionRef, { 
                    name, 
                    cost, 
                    margin: marginPercent, // Guardar el % (ej. 50)
                    price // Guardamos el precio calculado
                });
                showToast("Producto guardado");
                addProductForm.reset();
                productPricePublicOutput.value = "";
            } catch (error) {
                console.error("Error al guardar producto:", error);
                showToast("Error al guardar producto", true);
            }
        }

        // --- Renderizar Lista (Admin) ---
        function renderAdminProductsList() {
            const searchTerm = adminProductSearch.value.toLowerCase();
            const filteredProducts = productsData.filter(p => p.name.toLowerCase().includes(searchTerm));
            
            if (filteredProducts.length === 0) {
                productsList.innerHTML = '<p class="text-pink-dark/60">No se encontraron productos.</p>';
                return;
            }

            productsList.innerHTML = filteredProducts.map(product => `
                <div class="border border-pink-100 p-3 rounded-lg flex justify-between items-center" data-id="${product.id}">
                    <div>
                        <p class="font-medium text-pink-dark">${product.name}</p>
                        <p class="text-sm text-pink-dark/70">
                            Público: ${formatCurrency(product.price)}
                        </p>
                    </div>
                    <button class="delete-product text-red-400 hover:text-red-600 font-bold text-xl">&times;</button>
                </div>
            `).join('');
        }
        
        // ------------------------------------------------------------------
        // Lógica del COTIZADOR (¡NUEVA!)
        // ------------------------------------------------------------------
        
        // --- Renderizar Catálogo (Cotizador) ---
        function renderQuoteCatalogList() {
            const searchTerm = quoteProductSearch.value.toLowerCase();
            const filteredProducts = productsData.filter(p => p.name.toLowerCase().includes(searchTerm));
            
            if (filteredProducts.length === 0) {
                quoteCatalogList.innerHTML = '<p class="text-pink-dark/60">No se encontraron productos.</p>';
                return;
            }

            quoteCatalogList.innerHTML = filteredProducts.map(product => `
                <div class="catalog-item border border-pink-100 p-3 rounded-lg flex justify-between items-center cursor-pointer" data-id="${product.id}">
                    <div>
                        <p class="font-medium text-pink-dark pointer-events-none">${product.name}</p>
                        <p class="text-sm text-pink-dark/70 pointer-events-none">${formatCurrency(product.price)}</p>
                    </div>
                    <button class="add-to-cart-btn bg-pink-primary text-white text-xs px-3 py-1 rounded-full font-semibold hover:bg-pink-secondary transition-all">
                        Agregar
                    </button>
                </div>
            `).join('');
        }

        // --- Agregar Producto al Carrito ---
        function addProductToCart(product) {
            // Verificar si el producto ya está en el carrito
            const existingItem = orderCart.find(item => item.id === product.id);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                orderCart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                });
            }
            renderOrderCart();
            updateOrderSummary();
        }

        // --- Renderizar Carrito ---
        function renderOrderCart() {
            if (orderCart.length === 0) {
                emptyCart.classList.remove('hidden');
                orderCartItems.innerHTML = '';
                orderCartItems.appendChild(emptyCart);
                return;
            }

            emptyCart.classList.add('hidden');
            orderCartItems.innerHTML = orderCart.map((item, index) => `
                <div class="flex justify-between items-center py-2 border-b border-pink-100" data-index="${index}">
                    <div>
                        <p class="font-medium text-pink-dark">${item.name}</p>
                        <p class="text-sm text-pink-dark/70">${item.quantity} x ${formatCurrency(item.price)} = <strong>${formatCurrency(item.price * item.quantity)}</strong></p>
                    </div>
                    <button class="remove-cart-item text-red-400 hover:text-red-600 font-bold text-lg cursor-pointer">&times;</button>
                </div>
            `).join('');
        }

        // --- Actualizar Resumen de Pedido ---
        function updateOrderSummary() {
            const distance = parseFloat(orderKmInput.value) || 0;
            
            const subtotal = orderCart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            const shipping = distance * COSTO_POR_KM;
            const total = subtotal + shipping;

            document.getElementById('orderSubtotal').textContent = formatCurrency(subtotal);
            document.getElementById('orderShipping').textContent = formatCurrency(shipping);
            document.getElementById('orderTotal').textContent = formatCurrency(total);
            
            return { subtotal, shipping, total, distance };
        }

        // --- Limpiar Pedido ---
        function clearOrder() {
            if (!confirm("¿Estás segura de limpiar este pedido?")) return;
            orderCart = [];
            newOrderForm.reset();
            document.getElementById('orderClientName').value = '';
            document.getElementById('orderKm').value = 0;
            renderOrderCart();
            updateOrderSummary();
        }

        // --- Guardar Pedido ---
        async function onSaveOrder(e) {
            e.preventDefault();
            
            if (orderCart.length === 0) {
                showToast("El carrito está vacío", true);
                return;
            }
            const clientName = document.getElementById('orderClientName').value;
            if (!clientName) {
                showToast("Escribe el nombre del cliente", true);
                return;
            }

            const summary = updateOrderSummary();

            try {
                await addDoc(ordersCollectionRef, {
                    clientName: clientName,
                    items: orderCart,
                    ...summary,
                    createdAt: serverTimestamp(),
                });
                
                showToast("Pedido guardado");
                clearOrder(); // Limpiar formulario

            } catch (error) {
                console.error("Error al guardar pedido:", error);
                showToast("Error al guardar pedido", true);
            }
        }
        
        // ------------------------------------------------------------------
        // Lógica de Pestaña PEDIDOS GUARDADOS
        // ------------------------------------------------------------------

        function renderOrderCard(order) {
            const date = order.createdAt?.toDate ? order.createdAt.toDate().toLocaleDateString('es-MX') : 'Fecha N/A';
            
            const itemsHtml = order.items.map(item => `
                <li class="text-sm text-pink-dark/80">${item.quantity}x ${item.name} - ${formatCurrency(item.price * item.quantity)}</li>
            `).join('');

            return `
                <div class="bg-white p-5 rounded-2xl shadow-lg" data-id="${order.id}">
                    <h3 class="font-bold text-lg text-pink-secondary">${order.clientName}</h3>
                    <p class="text-sm text-pink-dark/60 mb-3">ID: ${order.id.substring(0, 6)} | ${date}</p>
                    
                    <ul class="list-disc list-inside space-y-1 my-3 pl-1">${itemsHtml}</ul>
                    
                    <div class="mt-4 pt-4 border-t border-pink-100 space-y-1">
                        <p class="flex justify-between text-sm"><span>Subtotal:</span> <span class="font-medium">${formatCurrency(order.subtotal)}</span></p>
                        <p class="flex justify-between text-sm"><span>Envío (${order.distance} km):</span> <span class="font-medium">${formatCurrency(order.shipping)}</span></p>
                        <p class="flex justify-between text-base font-bold text-pink-secondary"><span>Total:</span> <span>${formatCurrency(order.total)}</span></p>
                    </div>

                    <div class="mt-6">
                        <button class="download-order-pdf w-full text-sm bg-blue-500 text-white py-2 px-3 rounded-lg font-semibold hover:bg-blue-600 transition-all duration-300">
                            Descargar PDF
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ------------------------------------------------------------------
        // Lógica de Generación de PDF
        // ------------------------------------------------------------------
        
        // Cargar jsPDF globalmente
        const { jsPDF } = window.jspdf;
        
        function getBasePDF(title) {
            const doc = new jsPDF();
            doc.setFont("helvetica", "normal");
            
            // Encabezado
            doc.setFontSize(22);
            doc.setTextColor(236, 72, 153); // Color 'pink-secondary'
            doc.text("MichiCatt Store", 20, 20);
            
            doc.setFontSize(10);
            doc.setTextColor(131, 24, 67); // Color 'pink-dark'
            doc.text("Reporte de Venta", 20, 28);
            
            doc.setFontSize(14);
            doc.setTextColor(40, 40, 40);
            doc.text(title, 190, 20, { align: 'right' });
            
            return doc;
        }

        // --- Generar PDF de Pedido ---
        function generateOrderPDF(order) {
            const doc = getBasePDF("Resumen de Pedido");
            const date = order.createdAt?.toDate ? order.createdAt.toDate().toLocaleDateString('es-MX') : 'Fecha N/A';
            
            doc.setFontSize(10);
            doc.text(`ID: ${order.id}`, 190, 26, { align: 'right' });
            doc.text(`Fecha: ${date}`, 190, 31, { align: 'right' });

            doc.setFontSize(12);
            doc.text("Cliente:", 20, 45);
            doc.setFont("helvetica", "bold");
            doc.text(order.clientName, 20, 52);
            
            const tableColumn = ["Cant.", "Producto", "Precio Unit.", "Total"];
            const tableRows = order.items.map(item => [
                item.quantity,
                item.name,
                formatCurrency(item.price),
                formatCurrency(item.price * item.quantity)
            ]);
            doc.autoTable(tableColumn, tableRows, { 
                startY: 65,
                theme: 'striped',
                headStyles: { fillColor: [236, 72, 153] },
            });
            
            const finalY = doc.autoTable.previous.finalY;
            doc.setFontSize(12);
            
            doc.text("Subtotal:", 140, finalY + 10);
            doc.text(formatCurrency(order.subtotal), 190, finalY + 10, { align: 'right' });
            doc.text(`Envío (${order.distance} km):`, 140, finalY + 17);
            doc.text(formatCurrency(order.shipping), 190, finalY + 17, { align: 'right' });

            doc.setFont("helvetica", "bold");
            doc.text("Total Pedido:", 140, finalY + 24);
            doc.text(formatCurrency(order.total), 190, finalY + 24, { align: 'right' });

            doc.save(`Pedido_${order.clientName}_${order.id.substring(0,6)}.pdf`);
        }

    </script>
</body>
</html>
