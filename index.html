<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MichiCatt Store</title> <!-- Se actualizará dinámicamente -->
    
    <!-- Meta tags para PWA -->
    <meta name="theme-color" content="#F472B6"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MichiCatt Store">
    
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de jsPDF para generar PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Carga de AutoTable para jsPDF (para tablas) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Configuración de Tailwind y Estilos Personalizados -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pink-primary': '#F472B6', // Rosa principal
                        'pink-secondary': '#EC4899', // Rosa más oscuro
                        'pink-light': '#FBCFE8', // Rosa claro
                        'pink-dark': '#831843', // Rosa muy oscuro (para texto)
                        'pink-bg': '#FFF1F2', // Fondo rosa muy pálido
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Fondo con huellitas de gatito */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cpath d='M25 10 C20 10, 10 20, 10 25 C10 30, 20 40, 25 40 C30 40, 40 30, 40 25 C40 20, 30 10, 25 10 Z M60 15 C55 15, 45 25, 45 30 C45 35, 55 45, 60 45 C65 45, 75 35, 75 30 C75 25, 65 15, 60 15 Z M85 20 C80 20, 70 30, 70 35 C70 40, 80 50, 85 50 C90 50, 100 40, 100 35 C100 30, 90 20, 85 20 Z M40 50 C30 50, 20 65, 20 75 C20 85, 30 95, 40 95 C50 95, 60 85, 60 75 C60 65, 50 50, 40 50 Z' fill='%23FBCFE8' opacity='0.2' transform='rotate(30 50 50)'/%3E%3C/svg%3E");
            background-repeat: repeat;
            background-size: 150px 150px;
            z-index: -1;
            opacity: 0.5;
        }
        /* Estilo para la barra de scroll de navegación */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none; /* IE y Edge */
            scrollbar-width: none; /* Firefox */
        }
        /* Efecto de pulsación para botones */
        .btn-pulse:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 15px 0 rgba(236, 72, 153, 0.3);
        }
        .btn-pulse:active {
            transform: scale(0.98);
        }
        /* Estilo para items clickables en catálogo */
        .catalog-item {
            transition: all 0.2s;
        }
        .catalog-item:hover {
            background-color: #FFF1F2; /* pink-bg */
            transform: translateX(4px);
        }
        /* Estilos para la Modal */
        #manageOrderModal {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="bg-pink-bg text-pink-dark font-sans relative min-h-screen overflow-x-hidden">

    <!-- Pantalla de Login -->
    <div id="loginScreen" class="fixed inset-0 z-50 flex items-center justify-center bg-pink-primary p-4">
        <div class="bg-white w-full max-w-sm p-8 rounded-2xl shadow-2xl text-center">
            <!-- Espacio para el Logo en Login -->
            <img id="logoImageLogin" src="" alt="Logo" class="max-h-20 mx-auto mb-4 hidden">
            
            <h1 class="text-3xl font-bold text-pink-secondary mb-2">MichiCatt Store</h1>
            <p class="text-pink-dark mb-6">Panel de Administración</p>
            <form id="loginForm">
                <div class="mb-4 text-left">
                    <label for="email" class="block text-sm font-medium text-pink-dark mb-1">Email</label>
                    <input type="email" id="email" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary focus:border-transparent outline-none" required>
                </div>
                <div class="mb-6 text-left">
                    <label for="password" class="block text-sm font-medium text-pink-dark mb-1">Contraseña</label>
                    <input type="password" id="password" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary focus:border-transparent outline-none" required>
                </div>
                <p id="loginError" class="text-red-500 text-sm mb-4 hidden">Usuario o contraseña incorrectos.</p>
                <button type="submit" class="w-full bg-pink-primary text-white py-2 px-4 rounded-lg font-semibold shadow-lg hover:bg-pink-secondary transition-all duration-300 btn-pulse">
                    Entrar
                </button>
            </form>
        </div>
    </div>

    <!-- Contenido Principal de la App (Oculto por defecto) -->
    <div id="appContainer" class="hidden">
        
        <!-- Cabecera -->
        <header class="bg-white shadow-md p-4 sticky top-0 z-40">
            <div class="container mx-auto flex justify-between items-center">
                
                <!-- Logo y Título -->
                <div class="flex items-center gap-3">
                    <img id="logoImageHeader" src="" alt="Logo" class="max-h-10 hidden">
                    <h1 id="appNameTitle" class="text-xl sm:text-2xl font-bold text-pink-secondary">MichiCatt Store</h1>
                </div>

                <!-- Botón de Cerrar Sesión -->
                <div class="flex items-center gap-4">
                    <span id="welcomeUser" class="text-sm text-pink-dark font-medium hidden sm:block"></span>
                    <button id="logoutButton" class="text-pink-dark/70 hover:text-pink-primary" title="Cerrar Sesión">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Navegación por Pestañas -->
        <nav class="bg-white shadow-sm sticky top-[68px] sm:top-[76px] z-30">
            <div class="container mx-auto px-4">
                <div class="flex border-b border-pink-100 overflow-x-auto no-scrollbar">
                    <button data-tab="cotizador" class="tab-button active-tab flex-shrink-0 text-pink-secondary border-b-2 border-pink-primary py-3 px-4 font-medium">
                        Cotizador
                    </button>
                    <button data-tab="pedidos" class="tab-button flex-shrink-0 text-pink-dark/70 hover:text-pink-primary py-3 px-4 font-medium">
                        Pedidos Guardados
                    </button>
                    <button data-tab="productos" class="tab-button flex-shrink-0 text-pink-dark/70 hover:text-pink-primary py-3 px-4 font-medium">
                        Productos
                    </button>
                    <button data-tab="config" class="tab-button flex-shrink-0 text-pink-dark/70 hover:text-pink-primary py-3 px-4 font-medium">
                        Configuración
                    </button>
                </div>
            </div>
        </nav>

        <!-- Contenedor de Pestañas -->
        <main class="container mx-auto p-4 md:p-6">
            
            <!-- Pestaña: Cotizador -->
            <div id="cotizador" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    <!-- Columna 1: Mi Catálogo -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold text-pink-secondary mb-4">Mi Catálogo</h2>
                        <input type="text" id="quoteProductSearch" class="w-full px-4 py-2 border border-pink-light rounded-lg mb-4" placeholder="Buscar producto...">
                        <div id="quoteCatalogList" class="max-h-96 overflow-y-auto pr-2 space-y-2">
                            <!-- Lista de productos del catálogo se cargará aquí -->
                            <p id="noCatalogProducts" class="text-pink-dark/60">Agrega productos en la pestaña 'Productos'.</p>
                        </div>
                    </div>

                    <!-- Columna 2: Nuevo Pedido -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg space-y-4">
                        <h2 class="text-2xl font-bold text-pink-secondary">Nuevo Pedido</h2>
                        
                        <!-- Formulario de Pedido -->
                        <form id="newOrderForm">
                            <div>
                                <label for="orderClientName" class="block text-sm font-medium text-pink-dark mb-1">Nombre del Cliente (Manual)</label>
                                <input type="text" id="orderClientName" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none" required>
                            </div>
                            <div>
                                <label for="orderKm" class="block text-sm font-medium text-pink-dark mb-1">Envío (Kilómetros)</label>
                                <input type="number" id="orderKm" value="0" min="0" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none" required>
                            </div>
                        </form>
                        
                        <!-- Carrito de Pedido -->
                        <h3 class="text-lg font-semibold text-pink-dark pt-2">Carrito de Pedido</h3>
                        <div id="orderCartItems" class="mb-4 max-h-60 overflow-y-auto pr-2 space-y-2">
                            <!-- Los artículos del carrito se agregarán aquí -->
                            <p id="emptyCart" class="text-pink-dark/60">Agrega productos desde el catálogo.</p>
                        </div>
                        
                        <!-- Resumen de Costos -->
                        <div class="bg-pink-bg p-4 rounded-lg space-y-2">
                            <h4 class="text-lg font-bold text-pink-dark">Resumen del Pedido</h4>
                            <div class="flex justify-between">
                                <span class="text-pink-dark">Subtotal Productos:</span>
                                <span id="orderSubtotal" class="font-semibold text-pink-dark">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-pink-dark">Costo de Envío:</span>
                                <span id="orderShipping" class="font-semibold text-pink-dark">$0.00</span>
                            </div>
                            <div class="flex justify-between text-xl font-bold text-pink-secondary pt-2 border-t border-pink-light">
                                <span>Total:</span>
                                <span id="orderTotal">$0.00</span>
                            </div>
                        </div>
                        
                        <!-- Botones de Acción -->
                        <div class="flex gap-4">
                            <button type="button" id="clearOrderBtn" class="w-1/2 bg-gray-300 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-400 transition-all duration-300">
                                Limpiar
                            </button>
                            <button type="button" id="saveOrderBtn" class="w-1/2 bg-green-500 text-white py-2 px-4 rounded-lg font-semibold shadow-lg hover:bg-green-600 transition-all duration-300 btn-pulse">
                                Guardar Pedido
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pestaña: Pedidos Guardados -->
            <div id="pedidos" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-pink-secondary mb-6">Pedidos Guardados</h2>
                <div id="ordersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Los pedidos guardados se cargarán aquí -->
                    <p id="noOrders" class="col-span-full text-pink-dark/60">No hay pedidos guardados.</p>
                </div>
            </div>

            <!-- Pestaña: Productos -->
            <div id="productos" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Columna 1: Agregar/Editar Producto -->
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h2 class="text-2xl font-bold text-pink-secondary mb-6">Agregar Producto</h2>
                            <form id="addProductForm">
                                <div class="mb-4">
                                    <label for="productName" class="block text-sm font-medium text-pink-dark mb-1">Nombre del Producto</label>
                                    <input type="text" id="productName" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none" required>
                                </div>
                                <div class="mb-4">
                                    <label for="productCost" class="block text-sm font-medium text-pink-dark mb-1">Costo Real (Cuánto te costó)</label>
                                    <input type="number" id="productCost" min="0" step="0.01" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none" required>
                                </div>
                                <div class="mb-4">
                                    <label for="productMargin" class="block text-sm font-medium text-pink-dark mb-1">% de Ganancia (ej. 50)</label>
                                    <input type="number" id="productMargin" min="0" max="99.99" step="0.01" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none" required>
                                </div>
                                <!-- Precio al Cliente (Solo Lectura) -->
                                <div class="mb-6">
                                    <label for="productPricePublic" class="block text-sm font-medium text-pink-dark mb-1">Precio al Cliente (Calculado)</label>
                                    <input type="text" id="productPricePublic" class="w-full px-4 py-2 border border-pink-light rounded-lg bg-pink-bg text-pink-dark font-bold outline-none" readonly>
                                </div>
                                <button type="submit" id="saveProductBtn" class="w-full bg-pink-primary text-white py-2 px-4 rounded-lg font-semibold shadow-lg hover:bg-pink-secondary transition-all duration-300 btn-pulse">
                                    Guardar Producto
                                </button>
                                <!-- Botón de Cancelar Edición -->
                                <button type="button" id="productEditCancelBtn" class="w-full mt-2 bg-gray-300 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-400 transition-all duration-300 hidden">
                                    Cancelar Edición
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Columna 2 y 3: Mi Catálogo -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold text-pink-secondary mb-4">Mi Catálogo de Productos</h2>
                        <input type="text" id="adminProductSearch" class="w-full px-4 py-2 border border-pink-light rounded-lg mb-4" placeholder="Buscar producto...">
                        <div id="productsList" class="space-y-3 max-h-[600px] overflow-y-auto pr-2">
                            <!-- Lista de productos se cargará aquí -->
                            <p id="noProducts" class="col-span-full text-pink-dark/60">No hay productos guardados.</p>
                        </div>
                    </div>
                </div>
            </div>

            
            <!-- Pestaña: Configuración -->
            <div id="config" class="tab-content hidden">
                <div class="max-w-2xl mx-auto space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold text-pink-secondary mb-6">Configuración General</h2>
                        
                        <div class="space-y-4">
                            <!-- Nombre de la Tienda -->
                            <div>
                                <label for="storeName" class="block text-sm font-medium text-pink-dark mb-1">Nombre de la Tienda</label>
                                <input type="text" id="storeName" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none">
                            </div>

                            <!-- URL del Logo -->
                            <div>
                                <label for="logoUrl" class="block text-sm font-medium text-pink-dark mb-1">URL del Logo de la Tienda</label>
                                <input type="url" id="logoUrl" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none" placeholder="https://ejemplo.com/logo.png">
                            </div>

                            <div>
                                <label for="shippingCost" class="block text-sm font-medium text-pink-dark mb-1">Costo de Envío por KM</label>
                                <input type="number" id="shippingCost" min="0" step="0.01" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none">
                            </div>

                            <!-- Configuración de Folios -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="folioPrefix" class="block text-sm font-medium text-pink-dark mb-1">Prefijo de Folio</label>
                                    <input type="text" id="folioPrefix" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none" placeholder="MC-S-">
                                </div>
                                <div>
                                    <label for="nextFolio" class="block text-sm font-medium text-pink-dark mb-1">Próximo Folio (N°)</label>
                                    <input type="number" id="nextFolio" min="1" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none" placeholder="1">
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" id="saveSettingsBtn" class="mt-6 w-full bg-pink-primary text-white py-2 px-4 rounded-lg font-semibold shadow-lg hover:bg-pink-secondary transition-all duration-300 btn-pulse">
                            Guardar Ajustes
                        </button>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-semibold text-pink-dark mb-4">Gestión de Cuenta</h3>
                        <p class="text-sm text-pink-dark/70">
                            Para agregar nuevos administradores o cambiar tu contraseña, debes hacerlo de forma segura desde la
                            <a href="https://console.firebase.google.com/" target="_blank" class="text-pink-primary font-medium underline">Consola de Firebase</a>
                            en la sección de <strong>Authentication</strong>.
                        </p>
                    </div>
                </div>
            </div>
            
        </main>
    </div>

    <!-- Notificación Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-xl opacity-0 transform translate-y-10 transition-all duration-500 z-50">
        ¡Guardado correctamente!
    </div>

    <!-- ¡NUEVO! Modal para Gestionar Pagos y Envíos -->
    <div id="manageOrderModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 opacity-0 pointer-events-none">
        <div class="bg-white w-full max-w-lg p-6 rounded-2xl shadow-2xl space-y-4" id="modalContent">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-pink-secondary">Gestionar Pedido (<span id="modalFolio"></span>)</h2>
                <button id="closeModalBtn" class="text-pink-dark/70 hover:text-pink-primary">&times;</button>
            </div>
            
            <input type="hidden" id="modalOrderId"> <!-- Guarda el ID del pedido -->
            
            <!-- Sección de Pagos -->
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-pink-dark">Gestión de Pagos</h3>
                <!-- Resumen Financiero -->
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div>
                        <span class="text-xs text-pink-dark/70">TOTAL</span>
                        <p id="modalTotal" class="text-lg font-bold text-pink-dark">$0.00</p>
                    </div>
                    <div>
                        <span class="text-xs text-pink-dark/70">PAGADO</span>
                        <p id="modalPagado" class="text-lg font-bold text-green-600">$0.00</p>
                    </div>
                    <div>
                        <span class="text-xs text-pink-dark/70">SALDO PENDIENTE</span>
                        <p id="modalSaldo" class="text-lg font-bold text-red-600">$0.00</p>
                    </div>
                </div>
                
                <!-- Formulario de Abono -->
                <div class="space-y-2">
                    <label for="addPaymentAmount" class="text-sm font-medium text-pink-dark">Añadir Abono:</label>
                    <div class="flex gap-2">
                        <input type="number" id="addPaymentAmount" min="0.01" step="0.01" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none" placeholder="Monto">
                        <button id="addPaymentBtn" class="bg-green-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-600">Abonar</button>
                    </div>
                </div>
                
                <!-- Historial de Pagos -->
                <div>
                    <h4 class="text-sm font-medium text-pink-dark mb-2">Historial de Pagos:</h4>
                    <div id="paymentHistoryList" class="max-h-24 overflow-y-auto bg-pink-bg p-2 rounded-lg space-y-1">
                        <!-- historial de pagos aquí -->
                        <p id="noPayments" class="text-pink-dark/60 text-sm">No hay pagos registrados.</p>
                    </div>
                </div>
            </div>
            
            <!-- Sección de Entrega -->
            <div class="pt-4 border-t border-pink-100">
                <h3 class="text-lg font-semibold text-pink-dark mb-2">Gestión de Entrega</h3>
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm font-medium text-pink-dark">Estado Actual:</p>
                        <span id="modalDeliveryStatus" class="text-base font-bold text-pink-dark"></span>
                    </div>
                    <button id="toggleDeliveryBtn" class="bg-blue-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-600">Marcar como...</button>
                </div>
            </div>
            
        </div>
    </div>


    <!-- Script de Registro de PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>

    <!-- ================================================================== -->
    <!-- Carga de Firebase y Lógica de la App -->
    <!-- ================================================================== -->
    
    <!-- Importar Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            addDoc, 
            collection, 
            onSnapshot,
            query,
            getDoc, // ¡NUEVO! Necesario para la lógica de edición
            deleteDoc,
            serverTimestamp,
            arrayUnion // ¡NUEVO! Para el historial de pagos
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ------------------------------------------------------------------
        // CONFIGURACIÓN DE FIREBASE (¡YA ESTÁ LISTA!)
        // ------------------------------------------------------------------
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyD7XyxOW8rWjptvHt4u6ebf-9FZj4otA5Q",
          authDomain: "michicatt-store.firebaseapp.com",
          projectId: "michicatt-store",
          storageBucket: "michicatt-store.firebasestorage.app",
          messagingSenderId: "742378744678",
          appId: "1:742378744678:web:8fdac890199575d414f6a7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('Debug'); // Activar logs de Firestore

        // ------------------------------------------------------------------
        // Variables Globales y Estado de la App
        // ------------------------------------------------------------------
        
        // Referencias a elementos del DOM
        const loginScreen = document.getElementById('loginScreen');
        const appContainer = document.getElementById('appContainer');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const welcomeUser = document.getElementById('welcomeUser');
        const toast = document.getElementById('toast');
        const logoutButton = document.getElementById('logoutButton'); 
        
        // Logos
        const logoImageLogin = document.getElementById('logoImageLogin');
        const logoImageHeader = document.getElementById('logoImageHeader');

        // Pestañas
        const tabs = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        // Formularios
        const addProductForm = document.getElementById('addProductForm');
        const newOrderForm = document.getElementById('newOrderForm'); // Cotizador

        // Botones
        const saveOrderBtn = document.getElementById('saveOrderBtn');
        const clearOrderBtn = document.getElementById('clearOrderBtn');
        const saveProductBtn = document.getElementById('saveProductBtn');
        const productEditCancelBtn = document.getElementById('productEditCancelBtn');

        // Listas
        const productsList = document.getElementById('productsList'); // Admin
        const ordersList = document.getElementById('ordersList');
        const quoteCatalogList = document.getElementById('quoteCatalogList'); // Cotizador
        const orderCartItems = document.getElementById('orderCartItems');

        // IDs
        const noProducts = document.getElementById('noProducts');
        const noOrders = document.getElementById('noOrders');
        const emptyCart = document.getElementById('emptyCart');
        const noCatalogProducts = document.getElementById('noCatalogProducts');

        // Búsqueda
        const adminProductSearch = document.getElementById('adminProductSearch');
        const quoteProductSearch = document.getElementById('quoteProductSearch');
        
        // Inputs Formulario Productos
        const productCostInput = document.getElementById('productCost');
        const productMarginInput = document.getElementById('productMargin');
        const productPricePublicOutput = document.getElementById('productPricePublic');

        // Inputs Formulario Pedido
        const orderKmInput = document.getElementById('orderKm');
        
        // Inputs de Configuración
        const shippingCostInput = document.getElementById('shippingCost');
        const storeNameInput = document.getElementById('storeName');
        const logoUrlInput = document.getElementById('logoUrl'); 
        const folioPrefixInput = document.getElementById('folioPrefix');
        const nextFolioInput = document.getElementById('nextFolio');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        
        // ¡NUEVO! Elementos de la Modal
        const manageOrderModal = document.getElementById('manageOrderModal');
        const modalContent = document.getElementById('modalContent');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalOrderId = document.getElementById('modalOrderId');
        const modalFolio = document.getElementById('modalFolio');
        const modalTotal = document.getElementById('modalTotal');
        const modalPagado = document.getElementById('modalPagado');
        const modalSaldo = document.getElementById('modalSaldo');
        const addPaymentAmount = document.getElementById('addPaymentAmount');
        const addPaymentBtn = document.getElementById('addPaymentBtn');
        const paymentHistoryList = document.getElementById('paymentHistoryList');
        const noPayments = document.getElementById('noPayments');
        const modalDeliveryStatus = document.getElementById('modalDeliveryStatus');
        const toggleDeliveryBtn = document.getElementById('toggleDeliveryBtn');


        // Estado de la App
        let userId = null;
        let appSettings = {
            storeName: 'MichiCatt Store',
            shippingCost: 23.99 / 7, // $3.427...
            folioPrefix: 'MC-S-',
            nextFolio: 1,
            logoUrl: '' 
        };
        let productsData = []; // Caché local de productos
        let orderCart = []; // Carrito de pedido
        let editingOrderId = null; // Para saber si estamos editando
        let editingProductId = null; // Para editar productos
        let ordersData = []; // Caché local de pedidos
        
        // Listeners (unsubscribers) de Firestore
        let productListener = null;
        let orderListener = null;
        let settingsListener = null;

        // Referencias a Colecciones de Firestore
        let productCollectionRef;
        let ordersCollectionRef;
        let settingsDocRef; 

        // ------------------------------------------------------------------
        // Lógica de Autenticación (¡MODIFICADA PARA AUTH REAL!)
        // ------------------------------------------------------------------

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // --- Usuario está logueado ---
                console.log("Usuario logueado:", user.uid);
                userId = user.uid; // ¡El UID real del usuario!
                
                welcomeUser.textContent = `¡Hola, ${user.email.split('@')[0]}!`;
                loginScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                
                initializeAppLocal(userId);
                
            } else {
                // --- Usuario no está logueado ---
                console.log("Usuario deslogueado.");
                userId = null;
                
                loginScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
                
                cleanupListeners();
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            loginError.classList.add('hidden'); 

            try {
                await signInWithEmailAndPassword(auth, email, password);
                
            } catch (error) {
                console.error("Error al iniciar sesión:", error.code);
                let message = "Error al iniciar sesión.";
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    message = "Email o contraseña incorrectos.";
                } else if (error.code === 'auth/invalid-email') {
                    message = "El formato del email es incorrecto.";
                }
                loginError.textContent = message;
                loginError.classList.remove('hidden');
            }
        });

        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                showToast("Error al cerrar sesión", true);
            }
        });

        // ------------------------------------------------------------------
        // Inicialización de la App
        // ------------------------------------------------------------------
        
        function initializeAppLocal(uid) { 
            if (!uid) {
                console.error("¡Fallo de inicialización! No hay UID.");
                return;
            }
            
            cleanupListeners();
            
            initFirestoreRefs();
            initEventListeners();
            initDataListeners();
        }

        // ------------------------------------------------------------------
        // Inicialización de Firestore (¡RUTAS COMPARTIDAS!)
        // ------------------------------------------------------------------
        
        function initFirestoreRefs() {
            if (!userId) return;
            // ¡RUTAS CAMBIADAS! Ya no dependen de 'userId'
            productCollectionRef = collection(db, 'products');
            ordersCollectionRef = collection(db, 'orders');
            settingsDocRef = doc(db, 'config', 'main');
        }
        
        // ------------------------------------------------------------------
        // Lógica de Pestañas
        // ------------------------------------------------------------------
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => {
                    t.classList.remove('active-tab', 'text-pink-secondary', 'border-pink-primary');
                    t.classList.add('text-pink-dark/70', 'hover:text-pink-primary');
                });
                tabContents.forEach(c => c.classList.add('hidden'));

                tab.classList.add('active-tab', 'text-pink-secondary', 'border-pink-primary');
                tab.classList.remove('text-pink-dark/70', 'hover:text-pink-primary');
                document.getElementById(tab.dataset.tab).classList.remove('hidden');
            });
        });

        // ------------------------------------------------------------------
        // Lógica de Toast (Notificación)
        // ------------------------------------------------------------------
        
        function showToast(message, isError = false) {
            toast.textContent = message;
            if (isError) {
                toast.classList.remove('bg-green-500');
                toast.classList.add('bg-red-500');
            } else {
                toast.classList.remove('bg-red-500');
                toast.classList.add('bg-green-500');
            }
            
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-10');
            }, 3000);
        }

        // ------------------------------------------------------------------
        // Lógica de Formateo
        // ------------------------------------------------------------------
        
        const formatCurrency = (value) => {
            return (value || 0).toLocaleString('es-MX', {
                style: 'currency',
                currency: 'MXN',
            });
        };
        
        // ------------------------------------------------------------------
        // Listeners de Eventos (Solo se registran una vez)
        // ------------------------------------------------------------------
        
        let eventListenersInitialized = false;

        function initEventListeners() {
            if (eventListenersInitialized) return; // Prevenir duplicados
            
            // Formularios
            addProductForm.addEventListener('submit', onSaveProduct);
            
            // Botones
            saveOrderBtn.addEventListener('click', onSaveOrder);
            clearOrderBtn.addEventListener('click', handleClearOrderClick); 
            saveSettingsBtn.addEventListener('click', onSaveSettings); 
            productEditCancelBtn.addEventListener('click', cancelProductEdit); 
            
            // Búsqueda
            adminProductSearch.addEventListener('input', renderAdminProductsList);
            quoteProductSearch.addEventListener('input', renderQuoteCatalogList);
            
            // Clics en listas (Delegación de eventos)
            document.addEventListener('click', handleDocumentClick);

            // Calculadora de Precio de Producto
            productCostInput.addEventListener('input', updateCalculatedPrice);
            productMarginInput.addEventListener('input', updateCalculatedPrice);
            
            // Calculadora de Envío
            orderKmInput.addEventListener('input', updateOrderSummary);
            
            // ¡NUEVO! Listeners de la Modal
            closeModalBtn.addEventListener('click', closeManageModal);
            addPaymentBtn.addEventListener('click', onRegistrarPago);
            toggleDeliveryBtn.addEventListener('click', onToggleDelivery);
            // Cerrar modal al hacer clic en el fondo
            manageOrderModal.addEventListener('click', (e) => {
                if (e.target === manageOrderModal) {
                    closeManageModal();
                }
            });
            
            eventListenersInitialized = true;
        }

        // ------------------------------------------------------------------
        // Listeners de Datos (Firestore)
        // ------------------------------------------------------------------

        function initDataListeners() {
            if (!userId) return;

            // Listener de Productos
            productListener = onSnapshot(query(productCollectionRef), (snapshot) => {
                productsData = [];
                
                if (snapshot.empty) {
                    noProducts.classList.remove('hidden');
                    noCatalogProducts.classList.remove('hidden');
                    productsList.innerHTML = '';
                    quoteCatalogList.innerHTML = '';
                } else {
                    noProducts.classList.add('hidden');
                    noCatalogProducts.classList.add('hidden');
                    snapshot.forEach(doc => {
                        productsData.push({ ...doc.data(), id: doc.id });
                    });
                    productsData.sort((a, b) => a.name.localeCompare(b.name));
                    
                    renderAdminProductsList();
                    renderQuoteCatalogList();
                }
            });

            // Listener de Pedidos Guardados
            orderListener = onSnapshot(query(ordersCollectionRef), (snapshot) => {
                ordersData = []; // Limpiar caché local
                if (snapshot.empty) {
                    noOrders.classList.remove('hidden');
                    ordersList.innerHTML = '';
                } else {
                    noOrders.classList.add('hidden');
                    const orderItems = [];
                    snapshot.forEach(doc => {
                        const order = { ...doc.data(), id: doc.id };
                        ordersData.push(order); // Guardar caché local
                        orderItems.push(renderOrderCard(order));
                    });
                    // ¡NUEVO! Ordenar pedidos por fecha, más nuevos primero
                    ordersList.innerHTML = orderItems.sort((a, b) => {
                        const orderA = ordersData.find(o => o.id === a.match(/data-id="([^"]+)"/)[1]);
                        const orderB = ordersData.find(o => o.id === b.match(/data-id="([^"]+)"/)[1]);
                        return (orderB.createdAt?.seconds || 0) - (orderA.createdAt?.seconds || 0);
                    }).join('');
                }
            });
            
            // Listener de Configuración
            settingsListener = onSnapshot(settingsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    appSettings = { ...appSettings, ...docSnap.data() }; 
                } else {
                    setDoc(settingsDocRef, appSettings).catch(e => console.error("Error creating default settings:", e));
                }
                
                shippingCostInput.value = appSettings.shippingCost.toFixed(4);
                storeNameInput.value = appSettings.storeName;
                folioPrefixInput.value = appSettings.folioPrefix;
                nextFolioInput.value = appSettings.nextFolio;
                logoUrlInput.value = appSettings.logoUrl; 
                
                document.title = appSettings.storeName;
                document.getElementById('appNameTitle').textContent = appSettings.storeName;
                
                if (appSettings.logoUrl) {
                    logoImageLogin.src = appSettings.logoUrl;
                    logoImageHeader.src = appSettings.logoUrl;
                    logoImageLogin.classList.remove('hidden');
                    logoImageHeader.classList.remove('hidden');
                } else {
                    logoImageLogin.classList.add('hidden');
                    logoImageHeader.classList.add('hidden');
                }
                
                updateOrderSummary();
            });
        }
        
        function cleanupListeners() {
            if (productListener) productListener();
            if (orderListener) orderListener();
            if (settingsListener) settingsListener();
            
            productListener = null;
            orderListener = null;
            settingsListener = null;
            
            console.log("Listeners de Firestore detenidos.");
        }
        
        // ------------------------------------------------------------------
        // Manejador Global de Clics
        // ------------------------------------------------------------------
        
        async function handleDocumentClick(e) {
            // Clic en un producto del catálogo en Cotizador
            if (e.target.closest('.add-to-cart-btn')) {
                const item = e.target.closest('div[data-id]');
                const id = item.dataset.id;
                const product = productsData.find(p => p.id === id);
                if (product) {
                    addProductToCart(product);
                }
                return;
            }

            // Quitar item del carrito
            if (e.target.classList.contains('remove-cart-item')) {
                const item = e.target.closest('div[data-index]');
                if (item) {
                    const index = parseInt(item.dataset.index); 
                    orderCart.splice(index, 1);
                    renderOrderCart();
                    updateOrderSummary();
                }
                return;
            }
            
            // Clics en la lista de Productos del Admin
            const productItem = e.target.closest('#productsList div[data-id]');
            if (productItem) {
                const id = productItem.dataset.id;
                
                // Borrar Producto
                if (e.target.classList.contains('delete-product')) {
                    if (confirm("¿Estás segura de borrar este producto del catálogo?")) {
                        deleteDoc(doc(db, 'products', id))
                            .then(() => showToast("Producto eliminado"))
                            .catch(e => showToast("Error al eliminar", true));
                    }
                }
                
                // Editar Producto
                if (e.target.classList.contains('edit-product')) {
                    loadProductForEditing(id);
                }
                return;
            }

            // Acciones de Pedido (PDF, Eliminar, Editar)
            const orderCard = e.target.closest('#ordersList div[data-id]');
            if (orderCard) {
                const orderId = orderCard.dataset.id;
                
                // Botón de PDF
                if (e.target.classList.contains('download-order-pdf')) {
                    try {
                        const order = ordersData.find(o => o.id === orderId); 
                        if (order) {
                            generateOrderPDF(order);
                        }
                    } catch (error) { 
                        console.error("Error al generar PDF:", error);
                        showToast("Error al generar PDF", true); 
                    }
                }
                
                // Botón de Eliminar Pedido
                if (e.target.classList.contains('delete-order')) {
                    if (confirm("¿Estás segura de borrar este pedido? No se puede deshacer.")) {
                        deleteDoc(doc(db, 'orders', orderId))
                            .then(() => showToast("Pedido eliminado"))
                            .catch(e => showToast("Error al eliminar", true));
                    }
                }
                
                // Botón de Editar Pedido (lápiz)
                if (e.target.classList.contains('edit-order')) {
                    loadOrderForEditing(orderId);
                }
                
                // ¡NUEVO! Botón de Gestionar Pedido ($)
                if (e.target.classList.contains('manage-order')) {
                    const order = ordersData.find(o => o.id === orderId);
                    if (order) {
                        openManageModal(order);
                    }
                }
                return;
            }
        }

        // ------------------------------------------------------------------
        // Lógica de Pestaña PRODUCTOS
        // ------------------------------------------------------------------

        function updateCalculatedPrice() {
            const cost = parseFloat(productCostInput.value) || 0;
            const marginPercent = parseFloat(productMarginInput.value) || 0; 

            if (cost === 0) {
                productPricePublicOutput.value = formatCurrency(0);
                return;
            }

            if (marginPercent >= 100) {
                productPricePublicOutput.value = "Error: Margen >= 100%";
                return;
            }
            
            const margin = marginPercent / 100; 
            const price = cost / (1 - margin); 
            
            productPricePublicOutput.value = formatCurrency(price);
        }

        async function onSaveProduct(e) {
            e.preventDefault();
            const name = document.getElementById('productName').value;
            const cost = parseFloat(productCostInput.value);
            const marginPercent = parseFloat(productMarginInput.value); 

            if (isNaN(cost) || isNaN(marginPercent)) {
                showToast("Costo y Margen deben ser números", true);
                return;
            }
            
            if (marginPercent >= 100) {
                showToast("El margen no puede ser 100% o más", true);
                return;
            }

            const margin = marginPercent / 100; 
            const price = cost / (1 - margin); 

            const productData = { 
                name, 
                cost, 
                margin: marginPercent, 
                price 
            };

            try {
                if (editingProductId) {
                    await setDoc(doc(db, 'products', editingProductId), productData);
                    showToast("Producto actualizado");
                } else {
                    await addDoc(productCollectionRef, productData);
                    showToast("Producto guardado");
                }
                cancelProductEdit(); 
                
            } catch (error) {
                console.error("Error al guardar producto:", error);
                showToast("Error al guardar producto", true);
            }
        }
        
        function loadProductForEditing(id) {
            const product = productsData.find(p => p.id === id);
            if (!product) {
                showToast("No se encontró el producto", true);
                return;
            }
            
            document.getElementById('productName').value = product.name;
            productCostInput.value = product.cost;
            productMarginInput.value = product.margin;
            
            editingProductId = id;
            updateCalculatedPrice(); 
            
            saveProductBtn.textContent = "Actualizar Producto";
            productEditCancelBtn.classList.remove('hidden');
            
            addProductForm.scrollIntoView({ behavior: 'smooth' });
        }
        
        function cancelProductEdit() {
            editingProductId = null;
            addProductForm.reset();
            productPricePublicOutput.value = "";
            saveProductBtn.textContent = "Guardar Producto";
            productEditCancelBtn.classList.add('hidden');
        }

        function renderAdminProductsList() {
            const searchTerm = adminProductSearch.value.toLowerCase();
            const filteredProducts = productsData.filter(p => p.name.toLowerCase().includes(searchTerm));
            
            if (filteredProducts.length === 0) {
                productsList.innerHTML = '<p class="text-pink-dark/60">No se encontraron productos.</p>';
                return;
            }

            productsList.innerHTML = filteredProducts.map(product => `
                <div class="border border-pink-100 p-3 rounded-lg flex justify-between items-center" data-id="${product.id}">
                    <div>
                        <p class="font-medium text-pink-dark">${product.name}</p>
                        <p class="text-sm text-pink-dark/70">
                            Público: ${formatCurrency(product.price)}
                        </p>
                    </div>
                    <div class="flex gap-2">
                        <button class="edit-product text-blue-500 hover:text-blue-700 font-semibold text-lg" title="Editar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 13H3V6.414l5-5L9.414 3 5 7.414V13zM15 17H5v-5l-2-2v7a2 2 0 002 2h10a2 2 0 002-2v-2l-2 2z"/></svg>
                        </button>
                        <button class="delete-product text-red-400 hover:text-red-600 font-bold text-lg" title="Eliminar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 3a1 1 0 011-1h6a1 1 0 011 1v2h2a1 1 0 011 1v1H3V6a1 1 0 011-1h2V3zM3 10v7a2 2 0 002 2h10a2 2 0 002-2v-7H3zm3 4a1 1 0 102 0v-4a1 1 0 10-2 0v4zm4 0a1 1 0 102 0v-4a1 1 0 10-2 0v4z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // ------------------------------------------------------------------
        // Lógica del COTIZADOR
        // ------------------------------------------------------------------
        
        function renderQuoteCatalogList() {
            const searchTerm = quoteProductSearch.value.toLowerCase();
            const filteredProducts = productsData.filter(p => p.name.toLowerCase().includes(searchTerm));
            
            if (filteredProducts.length === 0) {
                quoteCatalogList.innerHTML = '<p class="text-pink-dark/60">No se encontraron productos.</p>';
                return;
            }

            quoteCatalogList.innerHTML = filteredProducts.map(product => `
                <div class="catalog-item border border-pink-100 p-3 rounded-lg flex justify-between items-center cursor-pointer" data-id="${product.id}">
                    <div>
                        <p class="font-medium text-pink-dark pointer-events-none">${product.name}</p>
                        <p class="text-sm text-pink-dark/70 pointer-events-none">${formatCurrency(product.price)}</p>
                    </div>
                    <button class="add-to-cart-btn bg-pink-primary text-white text-xs px-3 py-1 rounded-full font-semibold hover:bg-pink-secondary transition-all">
                        Agregar
                    </button>
                </div>
            `).join('');
        }

        function addProductToCart(product) {
            const existingItem = orderCart.find(item => item.id === product.id);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                orderCart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                });
            }
            renderOrderCart();
            updateOrderSummary();
        }

        function renderOrderCart() {
            if (orderCart.length === 0) {
                emptyCart.classList.remove('hidden');
                orderCartItems.innerHTML = '';
                orderCartItems.appendChild(emptyCart);
                return;
            }

            emptyCart.classList.add('hidden');
            orderCartItems.innerHTML = orderCart.map((item, index) => `
                <div class="flex justify-between items-center py-2 border-b border-pink-100" data-index="${index}">
                    <div>
                        <p class="font-medium text-pink-dark">${item.name}</p>
                        <p class="text-sm text-pink-dark/70">${item.quantity} x ${formatCurrency(item.price)} = <strong>${formatCurrency(item.price * item.quantity)}</strong></p>
                    </div>
                    <button class="remove-cart-item text-red-400 hover:text-red-600 font-bold text-lg cursor-pointer">&times;</button>
                </div>
            `).join('');
        }

        function updateOrderSummary() {
            const distance = parseFloat(orderKmInput.value) || 0;
            
            const subtotal = orderCart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            const shipping = distance * appSettings.shippingCost;
            const total = subtotal + shipping;

            document.getElementById('orderSubtotal').textContent = formatCurrency(subtotal);
            document.getElementById('orderShipping').textContent = formatCurrency(shipping);
            document.getElementById('orderTotal').textContent = formatCurrency(total);
            
            return { subtotal, shipping, total, distance };
        }

        function clearOrderForm() {
            orderCart = [];
            editingOrderId = null; 
            document.getElementById('orderClientName').value = '';
            document.getElementById('orderKm').value = 0;
            renderOrderCart();
            updateOrderSummary();
            
            saveOrderBtn.textContent = "Guardar Pedido";
            saveOrderBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            saveOrderBtn.classList.add('bg-green-500', 'hover:bg-green-600');
        }
        
        function handleClearOrderClick() {
            if (editingOrderId) {
                clearOrderForm();
            } else if (confirm("¿Estás segura de limpiar este pedido?")) {
                clearOrderForm();
            }
        }

        // --- Guardar Pedido (¡MODIFICADO!) ---
        async function onSaveOrder(e) {
            e.preventDefault();
            
            if (orderCart.length === 0) {
                showToast("El carrito está vacío", true);
                return;
            }
            const clientName = document.getElementById('orderClientName').value;
            if (!clientName) {
                showToast("Escribe el nombre del cliente", true);
                return;
            }

            const summary = updateOrderSummary();
            
            const orderData = {
                clientName: clientName,
                items: orderCart,
                ...summary, // total, subtotal, shipping, distance
            };

            try {
                if (editingOrderId) {
                    // --- MODO ACTUALIZACIÓN ---
                    // ¡Importante! Debemos recalcular el saldo
                    
                    // 1. Obtener el pedido actual para no perder los pagos
                    const orderDoc = await getDoc(doc(db, 'orders', editingOrderId));
                    const currentOrder = orderDoc.data();
                    const currentPagado = currentOrder.pagado || 0;
                    const currentHistorial = currentOrder.historialPagos || [];
                    
                    // 2. Recalcular saldo y estado de pago
                    const newTotal = summary.total;
                    const newSaldo = newTotal - currentPagado;
                    const newStatusPago = newSaldo <= 0.01 ? 'Liquidado' : (currentPagado > 0 ? 'Abonado' : 'Pendiente');
                    
                    // 3. Fusionar datos
                    const updatedOrderData = {
                        ...orderData, // Nuevos items, cliente, total, etc.
                        pagado: currentPagado,
                        historialPagos: currentHistorial,
                        saldoPendiente: newSaldo,
                        statusPago: newStatusPago,
                        statusEntrega: currentOrder.statusEntrega // Mantener estado de entrega
                    };
                    
                    await setDoc(doc(db, 'orders', editingOrderId), updatedOrderData, { merge: true });
                    showToast("Pedido actualizado");

                } else {
                    // --- MODO CREACIÓN (NUEVO PEDIDO) ---
                    // Generar folio
                    const folioString = appSettings.folioPrefix + String(appSettings.nextFolio).padStart(4, '0');
                    
                    // ¡NUEVO! Añadir campos de pago y estado
                    orderData.folio = folioString;
                    orderData.createdAt = serverTimestamp();
                    orderData.pagado = 0;
                    orderData.saldoPendiente = summary.total;
                    orderData.statusPago = 'Pendiente';
                    orderData.statusEntrega = 'Pendiente';
                    orderData.historialPagos = [];
                    
                    await addDoc(ordersCollectionRef, orderData);
                    
                    // Incrementar el folio en la config
                    const newNextFolio = appSettings.nextFolio + 1;
                    await setDoc(settingsDocRef, { nextFolio: newNextFolio }, { merge: true });
                    
                    showToast("Pedido guardado");
                }
                
                clearOrderForm(); 

            } catch (error) {
                console.error("Error al guardar pedido:", error);
                showToast("Error al guardar pedido", true);
            }
        }
        
        async function loadOrderForEditing(orderId) {
            // Usamos getDoc para asegurar que cargamos la última versión
            const orderDoc = await getDoc(doc(db, 'orders', orderId));
            if (!orderDoc.exists()) {
                showToast("No se encontró el pedido", true);
                return;
            }
            const order = orderDoc.data();
            
            // 1. Poner datos en el formulario
            editingOrderId = orderId;
            document.getElementById('orderClientName').value = order.clientName;
            document.getElementById('orderKm').value = order.distance;
            orderCart = JSON.parse(JSON.stringify(order.items)); // Copia profunda
            
            // 2. Actualizar UI del carrito
            renderOrderCart();
            updateOrderSummary();
            
            // 3. Cambiar botón a modo "Actualizar"
            saveOrderBtn.textContent = `Actualizar Pedido (${order.folio})`;
            saveOrderBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            saveOrderBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
            
            // 4. Cambiar a la pestaña del cotizador
            tabs.forEach(tab => {
                if (tab.dataset.tab === 'cotizador') {
                    tab.click();
                }
            });
            
            window.scrollTo(0, 0);
        }
        
        // ------------------------------------------------------------------
        // Lógica de Pestaña PEDIDOS GUARDADOS (¡MODIFICADA!)
        // ------------------------------------------------------------------

        function renderOrderCard(order) {
            const date = order.createdAt?.toDate ? order.createdAt.toDate().toLocaleDateString('es-MX') : 'Fecha N/D';
            
            // --- Lógica de Badges de Estado ---
            let paymentStatusTag = '';
            switch (order.statusPago) {
                case 'Liquidado':
                    paymentStatusTag = '<span class="text-xs font-medium bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Liquidado</span>';
                    break;
                case 'Abonado':
                    paymentStatusTag = '<span class="text-xs font-medium bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">Abonado</span>';
                    break;
                default: // Pendiente
                    paymentStatusTag = '<span class="text-xs font-medium bg-red-100 text-red-800 px-2 py-0.5 rounded-full">Pendiente</span>';
            }
            
            let deliveryStatusTag = '';
            switch (order.statusEntrega) {
                case 'Entregado':
                    deliveryStatusTag = '<span class="text-xs font-medium bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">Entregado</span>';
                    break;
                default: // Pendiente
                    deliveryStatusTag = '<span class="text-xs font-medium bg-gray-100 text-gray-800 px-2 py-0.5 rounded-full">Pendiente</span>';
            }
            // --- Fin Lógica de Badges ---

            return `
                <div class="bg-white p-5 rounded-2xl shadow-lg" data-id="${order.id}">
                    <div class="flex justify-between items-start">
                        <h3 class="font-bold text-lg text-pink-secondary">${order.clientName}</h3>
                        <span class="text-xs font-mono bg-pink-light text-pink-dark px-2 py-1 rounded-full">${order.folio || 'SIN-FOLIO'}</span>
                    </div>
                    <p class="text-sm text-pink-dark/60 mb-3">${date}</p>
                    
                    <!-- Estados -->
                    <div class="flex gap-2 mb-3">
                        ${paymentStatusTag}
                        ${deliveryStatusTag}
                    </div>
                    
                    <!-- ¡NUEVO! Resumen Financiero -->
                    <div class="mt-4 pt-4 border-t border-pink-100 space-y-1">
                        <p class="flex justify-between text-sm"><span>Total:</span> <span class="font-medium">${formatCurrency(order.total)}</span></p>
                        <p class="flex justify-between text-sm text-green-600"><span>Pagado:</span> <span class="font-medium">${formatCurrency(order.pagado)}</span></p>
                        <p class="flex justify-between text-base font-bold text-red-600"><span>Saldo:</span> <span>${formatCurrency(order.saldoPendiente)}</span></p>
                    </div>

                    <!-- Botones de Acción (4 botones) -->
                    <div class="mt-6 grid grid-cols-4 gap-2">
                        <button class="manage-order w-full text-xs bg-green-500 text-white py-2 px-2 rounded-lg font-semibold hover:bg-green-600 transition-all" title="Gestionar Pagos/Envío">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M8.433 7.418c.151-.102.331-.16.533-.16s.382.058.533.16l3.867 2.6c.294.198.467.538.467.91s-.173.712-.467.91l-3.867 2.6c-.151.102-.331.16-.533.16s-.382-.058-.533-.16L4.567 11.84c-.294-.198-.467-.538-.467-.91s.173-.712.467-.91l3.867-2.6zM12 6c.552 0 1 .448 1 1s-.448 1-1 1-1-.448-1-1 .448-1 1-1zm-4 0c.552 0 1 .448 1 1s-.448 1-1 1-1-.448-1-1 .448-1 1-1zM8 14c.552 0 1 .448 1 1s-.448 1-1 1-1-.448-1-1 .448-1 1-1zm4 0c.552 0 1 .448 1 1s-.448 1-1 1-1-.448-1-1 .448-1 1-1zM4 6c.552 0 1 .448 1 1s-.448 1-1 1-1-.448-1-1 .448-1 1-1z" /></svg>
                        </button>
                        <button class="download-order-pdf w-full text-xs bg-blue-500 text-white py-2 px-2 rounded-lg font-semibold hover:bg-blue-600 transition-all" title="Descargar PDF">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 11-2 0V4H6v12a1 1 0 11-2 0V4zm8 10a1 1 0 100-2H8a1 1 0 100 2h4z" clip-rule="evenodd" /></svg>
                        </button>
                        <button class="edit-order w-full text-xs bg-yellow-500 text-white py-2 px-2 rounded-lg font-semibold hover:bg-yellow-600 transition-all" title="Editar Productos">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 13H3V6.414l5-5L9.414 3 5 7.414V13zM15 17H5v-5l-2-2v7a2 2 0 002 2h10a2 2 0 002-2v-2l-2 2z"/></svg>
                        </button>
                        <button class="delete-order w-full text-xs bg-red-500 text-white py-2 px-2 rounded-lg font-semibold hover:bg-red-600 transition-all" title="Eliminar Pedido">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 3a1 1 0 011-1h6a1 1 0 011 1v2h2a1 1 0 011 1v1H3V6a1 1 0 011-1h2V3zM3 10v7a2 2 0 002 2h10a2 2 0 002-2v-7H3zm3 4a1 1 0 102 0v-4a1 1 0 10-2 0v4zm4 0a1 1 0 102 0v-4a1 1 0 10-2 0v4z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ------------------------------------------------------------------
        // Lógica de Generación de PDF (¡MODIFICADA!)
        // ------------------------------------------------------------------
        
        function getBasePDF(title) {
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF();
            doc.setFont("helvetica", "normal");
            
            doc.setFontSize(22);
            doc.setTextColor(236, 72, 153); 
            doc.text(appSettings.storeName, 20, 20); 
            
            doc.setFontSize(10);
            doc.setTextColor(131, 24, 67); 
            doc.text("Reporte de Venta", 20, 28);
            
            doc.setFontSize(14);
            doc.setTextColor(40, 40, 40);
            doc.text(title, 190, 20, { align: 'right' });
            
            return doc;
        }

        function generateOrderPDF(order) {
            const doc = getBasePDF("Resumen de Pedido");
            const date = order.createdAt?.toDate ? order.createdAt.toDate().toLocaleDateString('es-MX') : 'Fecha N/D';
            
            doc.setFontSize(10);
            doc.text(`ID: ${order.id}`, 190, 26, { align: 'right' });
            doc.text(`Fecha: ${date}`, 190, 31, { align: 'right' });
            doc.setFont("helvetica", "bold");
            doc.text(`Folio: ${order.folio || 'N/A'}`, 190, 36, { align: 'right' });

            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            
            doc.setFont("helvetica", "bold");
            doc.text("Cliente:", 20, 45);
            doc.setFont("helvetica", "normal");
            doc.text(order.clientName, 40, 45);
            
            const tableColumn = ["Cant.", "Producto", "Precio Unit.", "Total"];
            const tableRows = order.items.map(item => [
                item.quantity,
                item.name,
                formatCurrency(item.price),
                formatCurrency(item.price * item.quantity)
            ]);
            doc.autoTable(tableColumn, tableRows, { 
                startY: 65,
                theme: 'striped',
                headStyles: { fillColor: [236, 72, 153] },
            });
            
            const finalY = doc.autoTable.previous.finalY;
            doc.setFontSize(12);
            
            doc.text("Subtotal:", 140, finalY + 10);
            doc.text(formatCurrency(order.subtotal), 190, finalY + 10, { align: 'right' });
            doc.text(`Envío (${order.distance} km):`, 140, finalY + 17);
            doc.text(formatCurrency(order.shipping), 190, finalY + 17, { align: 'right' });

            doc.setFont("helvetica", "bold");
            doc.text("Total Pedido:", 140, finalY + 24);
            doc.text(formatCurrency(order.total), 190, finalY + 24, { align: 'right' });
            
            // --- ¡NUEVO! Resumen de Pagos ---
            doc.setFont("helvetica", "normal");
            doc.setTextColor(20, 20, 20);
            doc.text("Pagado:", 140, finalY + 31);
            doc.text(formatCurrency(order.pagado), 190, finalY + 31, { align: 'right' });
            
            doc.setFont("helvetica", "bold");
            doc.setTextColor(200, 0, 0); // Rojo
            doc.text("Saldo Pendiente:", 140, finalY + 38);
            doc.text(formatCurrency(order.saldoPendiente), 190, finalY + 38, { align: 'right' });
            // --- Fin Resumen de Pagos ---

            doc.save(`Pedido_${order.clientName}_${order.id.substring(0,6)}.pdf`);
        }

        // --- Guardar Ajustes de Configuración ---
        async function onSaveSettings(e) {
            e.preventDefault();
            const newCost = parseFloat(shippingCostInput.value);
            const newName = storeNameInput.value.trim();
            const newPrefix = folioPrefixInput.value;
            const newNextFolio = parseInt(nextFolioInput.value);
            const newLogoUrl = logoUrlInput.value.trim();
            
            if (isNaN(newCost) || newCost < 0) {
                showToast("El costo por KM debe ser un número positivo", true); return;
            }
            if (!newName) {
                showToast("El nombre de la tienda no puede estar vacío", true); return;
            }
            if (isNaN(newNextFolio) || newNextFolio < 1) {
                showToast("El próximo folio debe ser un número mayor a 0", true); return;
            }

            const newSettings = {
                shippingCost: newCost,
                storeName: newName,
                folioPrefix: newPrefix,
                nextFolio: newNextFolio,
                logoUrl: newLogoUrl
            };

            try {
                await setDoc(settingsDocRef, newSettings);
                appSettings = newSettings; 
                showToast("Ajustes guardados");
            } catch (error) {
                console.error("Error al guardar ajustes:", error);
                showToast("Error al guardar ajustes", true);
            }
        }
        
        // ------------------------------------------------------------------
        // ¡NUEVA! Lógica de la Modal de Gestión de Pedidos
        // ------------------------------------------------------------------
        
        function openManageModal(order) {
            // 1. Poblar datos
            modalOrderId.value = order.id;
            modalFolio.textContent = order.folio;
            modalTotal.textContent = formatCurrency(order.total);
            modalPagado.textContent = formatCurrency(order.pagado);
            modalSaldo.textContent = formatCurrency(order.saldoPendiente);
            
            // 2. Poblar historial de pagos
            if (!order.historialPagos || order.historialPagos.length === 0) {
                noPayments.classList.remove('hidden');
                paymentHistoryList.innerHTML = '';
                paymentHistoryList.appendChild(noPayments);
            } else {
                noPayments.classList.add('hidden');
                paymentHistoryList.innerHTML = order.historialPagos.map(pago => {
                    const date = pago.fecha?.toDate ? pago.fecha.toDate().toLocaleString('es-MX') : 'Fecha N/D';
                    return `<div class="text-sm flex justify-between"><span>${date}</span><span class="font-medium">${formatCurrency(pago.monto)}</span></div>`;
                }).join('');
            }
            
            // 3. Poblar estado de entrega
            if (order.statusEntrega === 'Entregado') {
                modalDeliveryStatus.textContent = "Entregado";
                modalDeliveryStatus.className = "font-bold text-blue-600";
                toggleDeliveryBtn.textContent = "Marcar como Pendiente";
                toggleDeliveryBtn.className = "bg-gray-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-gray-600";
            } else {
                modalDeliveryStatus.textContent = "Pendiente";
                modalDeliveryStatus.className = "font-bold text-gray-600";
                toggleDeliveryBtn.textContent = "Marcar como Entregado";
                toggleDeliveryBtn.className = "bg-blue-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-600";
            }

            // 4. Mostrar modal
            manageOrderModal.classList.remove('opacity-0', 'pointer-events-none');
        }
        
        function closeManageModal() {
            manageOrderModal.classList.add('opacity-0', 'pointer-events-none');
            addPaymentAmount.value = ''; // Limpiar input
        }
        
        // --- Registrar un nuevo pago (abono) ---
        async function onRegistrarPago() {
            const id = modalOrderId.value;
            const montoAbono = parseFloat(addPaymentAmount.value);
            
            if (isNaN(montoAbono) || montoAbono <= 0) {
                showToast("El monto a abonar no es válido", true);
                return;
            }
            
            // Obtener el pedido actual
            const orderRef = doc(db, 'orders', id);
            const docSnap = await getDoc(orderRef);
            if (!docSnap.exists()) {
                showToast("Error: No se encontró el pedido", true);
                return;
            }
            
            const order = docSnap.data();
            
            // Calcular nuevos totales
            const nuevoPagado = (order.pagado || 0) + montoAbono;
            const nuevoSaldo = order.total - nuevoPagado;
            const nuevoStatusPago = nuevoSaldo <= 0.01 ? 'Liquidado' : 'Abonado'; // 0.01 para errores de decimales
            
            const nuevoPago = {
                fecha: serverTimestamp(),
                monto: montoAbono
            };
            
            try {
                await setDoc(orderRef, {
                    pagado: nuevoPagado,
                    saldoPendiente: nuevoSaldo,
                    statusPago: nuevoStatusPago,
                    historialPagos: arrayUnion(nuevoPago) // Agrega al array
                }, { merge: true });
                
                showToast("¡Pago registrado!");
                addPaymentAmount.value = ''; // Limpiar
                // Actualizar la modal (el listener de onSnapshot lo hará automáticamente)
                // Pero lo forzamos por si acaso
                const updatedOrder = {...order, pagado: nuevoPagado, saldoPendiente: nuevoSaldo, statusPago: nuevoStatusPago, historialPagos: [...(order.historialPagos || []), {fecha: new Date(), monto: montoAbono}]};
                openManageModal(updatedOrder); // Re-abrir modal con datos frescos
                
            } catch (error) {
                console.error("Error al registrar pago:", error);
                showToast("Error al registrar pago", true);
            }
        }
        
        // --- Cambiar estado de entrega ---
        async function onToggleDelivery() {
            const id = modalOrderId.value;
            const orderRef = doc(db, 'orders', id);
            const docSnap = await getDoc(orderRef);
            if (!docSnap.exists()) {
                showToast("Error: No se encontró el pedido", true);
                return;
            }
            
            const currentStatus = docSnap.data().statusEntrega;
            const newStatus = currentStatus === 'Entregado' ? 'Pendiente' : 'Entregado';
            
            try {
                await setDoc(orderRef, { statusEntrega: newStatus }, { merge: true });
                showToast(`Estado actualizado a: ${newStatus}`);
                
                // Actualizar modal
                const updatedOrder = {...docSnap.data(), statusEntrega: newStatus, id: id};
                openManageModal(updatedOrder);
                
            } catch (error) {
                console.error("Error al actualizar entrega:", error);
                showToast("Error al actualizar entrega", true);
            }
        }

    </script>
</body>
</html>
