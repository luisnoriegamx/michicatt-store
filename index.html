<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MichiCatt Store</title> <meta name="theme-color" content="#F472B6"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MichiCatt Store">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pink-primary': '#F472B6', // Rosa principal
                        'pink-secondary': '#EC4899', // Rosa más oscuro
                        'pink-light': '#FBCFE8', // Rosa claro
                        'pink-dark': '#831843', // Rosa muy oscuro (para texto)
                        'pink-bg': '#FFF1F2', // Fondo rosa muy pálido
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Fondo con huellitas de gatito */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cpath d='M25 10 C20 10, 10 20, 10 25 C10 30, 20 40, 25 40 C30 40, 40 30, 40 25 C40 20, 30 10, 25 10 Z M60 15 C55 15, 45 25, 45 30 C45 35, 55 45, 60 45 C65 45, 75 35, 75 30 C75 25, 65 15, 60 15 Z M85 20 C80 20, 70 30, 70 35 C70 40, 80 50, 85 50 C90 50, 100 40, 100 35 C100 30, 90 20, 85 20 Z M40 50 C30 50, 20 65, 20 75 C20 85, 30 95, 40 95 C50 95, 60 85, 60 75 C60 65, 50 50, 40 50 Z' fill='%23FBCFE8' opacity='0.2' transform='rotate(30 50 50)'/%3E%3C/svg%3E");
            background-repeat: repeat;
            background-size: 150px 150px;
            z-index: -1;
            opacity: 0.5;
        }
        /* Estilo para la barra de scroll de navegación */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none; /* IE y Edge */
            scrollbar-width: none; /* Firefox */
        }
        /* Efecto de pulsación para botones */
        .btn-pulse:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 15px 0 rgba(236, 72, 153, 0.3);
        }
        .btn-pulse:active {
            transform: scale(0.98);
        }
        /* Estilo para items clickables en catálogo */
        .catalog-item {
            transition: all 0.2s;
        }
        .catalog-item:hover {
            background-color: #FFF1F2; /* pink-bg */
            transform: translateX(4px);
        }
    </style>
</head>
<body class="bg-pink-bg text-pink-dark font-sans relative min-h-screen overflow-x-hidden">

    <div id="loginScreen" class="fixed inset-0 z-50 flex items-center justify-center bg-pink-primary p-4">
        <div class="bg-white w-full max-w-sm p-8 rounded-2xl shadow-2xl text-center">
            <img id="logoImageLogin" src="" alt="Logo" class="max-h-20 mx-auto mb-4 hidden">
            
            <h1 class="text-3xl font-bold text-pink-secondary mb-2">MichiCatt Store</h1>
            <p class="text-pink-dark mb-6">Panel de Administración</p>
            <form id="loginForm">
                <div class="mb-4 text-left">
                    <label for="email" class="block text-sm font-medium text-pink-dark mb-1">Email</label>
                    <input type="email" id="email" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary focus:border-transparent outline-none" required>
                </div>
                <div class="mb-6 text-left">
                    <label for="password" class="block text-sm font-medium text-pink-dark mb-1">Contraseña</label>
                    <input type="password" id="password" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary focus:border-transparent outline-none" required>
                </div>
                <p id="loginError" class="text-red-500 text-sm mb-4 hidden">Usuario o contraseña incorrectos.</p>
                <button type="submit" class="w-full bg-pink-primary text-white py-2 px-4 rounded-lg font-semibold shadow-lg hover:bg-pink-secondary transition-all duration-300 btn-pulse">
                    Entrar
                </button>
            </form>
        </div>
    </div>

    <div id="appContainer" class="hidden">
        
        <header class="bg-white shadow-md p-4 sticky top-0 z-40">
            <div class="container mx-auto flex justify-between items-center">
                
                <div class="flex items-center gap-3">
                    <img id="logoImageHeader" src="" alt="Logo" class="max-h-10 hidden">
                    <h1 id="appNameTitle" class="text-xl sm:text-2xl font-bold text-pink-secondary">MichiCatt Store</h1>
                </div>

                <div class="flex items-center gap-4">
                    <span id="welcomeUser" class="text-sm text-pink-dark font-medium hidden sm:block"></span>
                    <button id="logoutButton" class="text-pink-dark/70 hover:text-pink-primary" title="Cerrar Sesión">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <nav class="bg-white shadow-sm sticky top-[68px] sm:top-[76px] z-30">
            <div class="container mx-auto px-4">
                <div class="flex border-b border-pink-100 overflow-x-auto no-scrollbar">
                    <button data-tab="cotizador" class="tab-button active-tab flex-shrink-0 text-pink-secondary border-b-2 border-pink-primary py-3 px-4 font-medium">
                        Cotizador
                    </button>
                    <button data-tab="pedidos" class="tab-button flex-shrink-0 text-pink-dark/70 hover:text-pink-primary py-3 px-4 font-medium">
                        Pedidos Guardados
                    </button>
                    <button data-tab="productos" class="tab-button flex-shrink-0 text-pink-dark/70 hover:text-pink-primary py-3 px-4 font-medium">
                        Productos
                    </button>
                    <button data-tab="config" class="tab-button flex-shrink-0 text-pink-dark/70 hover:text-pink-primary py-3 px-4 font-medium">
                        Configuración
                    </button>
                </div>
            </div>
        </nav>

        <main class="container mx-auto p-4 md:p-6">
            
            <div id="cotizador" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold text-pink-secondary mb-4">Mi Catálogo</h2>
                        <input type="text" id="quoteProductSearch" class="w-full px-4 py-2 border border-pink-light rounded-lg mb-4" placeholder="Buscar producto...">
                        <div id="quoteCatalogList" class="max-h-96 overflow-y-auto pr-2 space-y-2">
                            <p id="noCatalogProducts" class="text-pink-dark/60">Agrega productos en la pestaña 'Productos'.</p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-lg space-y-4">
                        <h2 class="text-2xl font-bold text-pink-secondary">Nuevo Pedido</h2>
                        
                        <form id="newOrderForm">
                            <div>
                                <label for="orderClientName" class="block text-sm font-medium text-pink-dark mb-1">Nombre del Cliente (Manual)</label>
                                <input type="text" id="orderClientName" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none" required>
                            </div>
                            <div>
                                <label for="orderKm" class="block text-sm font-medium text-pink-dark mb-1">Envío (Kilómetros)</label>
                                <input type="number" id="orderKm" value="0" min="0" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none" required>
                            </div>
                        </form>
                        
                        <h3 class="text-lg font-semibold text-pink-dark pt-2">Carrito de Pedido</h3>
                        <div id="orderCartItems" class="mb-4 max-h-60 overflow-y-auto pr-2 space-y-2">
                            <p id="emptyCart" class="text-pink-dark/60">Agrega productos desde el catálogo.</p>
                        </div>
                        
                        <div class="bg-pink-bg p-4 rounded-lg space-y-2">
                            <h4 class="text-lg font-bold text-pink-dark">Resumen del Pedido</h4>
                            <div class="flex justify-between">
                                <span class="text-pink-dark">Subtotal Productos:</span>
                                <span id="orderSubtotal" class="font-semibold text-pink-dark">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-pink-dark">Costo de Envío:</span>
                                <span id="orderShipping" class="font-semibold text-pink-dark">$0.00</span>
                            </div>
                            <div class="flex justify-between text-xl font-bold text-pink-secondary pt-2 border-t border-pink-light">
                                <span>Total:</span>
                                <span id="orderTotal">$0.00</span>
                            </div>
                        </div>
                        
                        <div class="flex gap-4">
                            <button type="button" id="clearOrderBtn" class="w-1/2 bg-gray-300 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-400 transition-all duration-300">
                                Limpiar
                            </button>
                            <button type="button" id="saveOrderBtn" class="w-1/2 bg-green-500 text-white py-2 px-4 rounded-lg font-semibold shadow-lg hover:bg-green-600 transition-all duration-300 btn-pulse">
                                Guardar Pedido
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="pedidos" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-pink-secondary mb-6">Pedidos Guardados</h2>
                <div id="ordersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p id="noOrders" class="col-span-full text-pink-dark/60">No hay pedidos guardados.</p>
                </div>
            </div>

            <div id="productos" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h2 class="text-2xl font-bold text-pink-secondary mb-6">Agregar Producto</h2>
                            <form id="addProductForm">
                                <div class="mb-4">
                                    <label for="productName" class="block text-sm font-medium text-pink-dark mb-1">Nombre del Producto</label>
                                    <input type="text" id="productName" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none" required>
                                </div>
                                <div class="mb-4">
                                    <label for="productCost" class="block text-sm font-medium text-pink-dark mb-1">Costo Real (Cuánto te costó)</label>
                                    <input type="number" id="productCost" min="0" step="0.01" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none" required>
                                </div>
                                <div class="mb-4">
                                    <label for="productMargin" class="block text-sm font-medium text-pink-dark mb-1">% de Ganancia (ej. 50)</label>
                                    <input type="number" id="productMargin" min="0" max="99.99" step="0.01" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none" required>
                                </div>
                                <div class="mb-6">
                                    <label for="productPricePublic" class="block text-sm font-medium text-pink-dark mb-1">Precio al Cliente (Calculado)</label>
                                    <input type="text" id="productPricePublic" class="w-full px-4 py-2 border border-pink-light rounded-lg bg-pink-bg text-pink-dark font-bold outline-none" readonly>
                                </div>
                                <button type="submit" id="saveProductBtn" class="w-full bg-pink-primary text-white py-2 px-4 rounded-lg font-semibold shadow-lg hover:bg-pink-secondary transition-all duration-300 btn-pulse">
                                    Guardar Producto
                                </button>
                                <button type="button" id="productEditCancelBtn" class="w-full mt-2 bg-gray-300 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-400 transition-all duration-300 hidden">
                                    Cancelar Edición
                                </button>
                            </form>
                        </div>
                    </div>

                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold text-pink-secondary mb-4">Mi Catálogo de Productos</h2>
                        <input type="text" id="adminProductSearch" class="w-full px-4 py-2 border border-pink-light rounded-lg mb-4" placeholder="Buscar producto...">
                        <div id="productsList" class="space-y-3 max-h-[600px] overflow-y-auto pr-2">
                            <p id="noProducts" class="col-span-full text-pink-dark/60">No hay productos guardados.</p>
                        </div>
                    </div>
                </div>
            </div>

            
            <div id="config" class="tab-content hidden">
                <div class="max-w-2xl mx-auto space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold text-pink-secondary mb-6">Configuración General</h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label for="storeName" class="block text-sm font-medium text-pink-dark mb-1">Nombre de la Tienda</label>
                                <input type="text" id="storeName" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none">
                            </div>

                            <div>
                                <label for="logoUrl" class="block text-sm font-medium text-pink-dark mb-1">URL del Logo de la Tienda</label>
                                <input type="url" id="logoUrl" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none" placeholder="https://ejemplo.com/logo.png">
                            </div>

                            <div>
                                <label for="shippingCost" class="block text-sm font-medium text-pink-dark mb-1">Costo de Envío por KM</label>
                                <input type="number" id="shippingCost" min="0" step="0.01" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="folioPrefix" class="block text-sm font-medium text-pink-dark mb-1">Prefijo de Folio</label>
                                    <input type="text" id="folioPrefix" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none" placeholder="MC-S-">
                                </div>
                                <div>
                                    <label for="nextFolio" class="block text-sm font-medium text-pink-dark mb-1">Próximo Folio (N°)</label>
                                    <input type="number" id="nextFolio" min="1" class="w-full px-4 py-2 border border-pink-light rounded-lg focus:ring-2 focus:ring-pink-primary outline-none" placeholder="1">
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" id="saveSettingsBtn" class="mt-6 w-full bg-pink-primary text-white py-2 px-4 rounded-lg font-semibold shadow-lg hover:bg-pink-secondary transition-all duration-300 btn-pulse">
                            Guardar Ajustes
                        </button>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-semibold text-pink-dark mb-4">Gestión de Cuenta</h3>
                        <p class="text-sm text-pink-dark/70">
                            Para agregar nuevos administradores o cambiar tu contraseña, debes hacerlo de forma segura desde la
                            <a href="https://console.firebase.google.com/" target="_blank" class="text-pink-primary font-medium underline">Consola de Firebase</a>
                            en la sección de <strong>Authentication</strong>.
                        </p>
                    </div>
                </div>
            </div>
            
        </main>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-xl opacity-0 transform translate-y-10 transition-all duration-500 z-50">
        ¡Guardado correctamente!
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            // ¡NUEVO! Imports para autenticación real
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            addDoc, 
            collection, 
            onSnapshot,
            query,
            getDoc,
            deleteDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ------------------------------------------------------------------
        // CONFIGURACIÓN DE FIREBASE (¡YA ESTÁ LISTA!)
        // ------------------------------------------------------------------
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyD7XyxOW8rWjptvHt4u6ebf-9FZj4otA5Q",
          authDomain: "michicatt-store.firebaseapp.com",
          projectId: "michicatt-store",
          storageBucket: "michicatt-store.firebasestorage.app",
          messagingSenderId: "742378744678",
          appId: "1:742378744678:web:8fdac890199575d414f6a7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('Debug'); // Activar logs de Firestore

        // ------------------------------------------------------------------
        // Variables Globales y Estado de la App
        // ------------------------------------------------------------------
        
        // Referencias a elementos del DOM
        const loginScreen = document.getElementById('loginScreen');
        const appContainer = document.getElementById('appContainer');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const welcomeUser = document.getElementById('welcomeUser');
        const toast = document.getElementById('toast');
        const logoutButton = document.getElementById('logoutButton'); 
        
        // Logos
        const logoImageLogin = document.getElementById('logoImageLogin');
        const logoImageHeader = document.getElementById('logoImageHeader');

        // Pestañas
        const tabs = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        // Formularios
        const addProductForm = document.getElementById('addProductForm');
        const newOrderForm = document.getElementById('newOrderForm'); // Cotizador

        // Botones
        const saveOrderBtn = document.getElementById('saveOrderBtn');
        const clearOrderBtn = document.getElementById('clearOrderBtn');
        const saveProductBtn = document.getElementById('saveProductBtn');
        const productEditCancelBtn = document.getElementById('productEditCancelBtn');

        // Listas
        const productsList = document.getElementById('productsList'); // Admin
        const ordersList = document.getElementById('ordersList');
        const quoteCatalogList = document.getElementById('quoteCatalogList'); // Cotizador
        const orderCartItems = document.getElementById('orderCartItems');

        // IDs
        const noProducts = document.getElementById('noProducts');
        const noOrders = document.getElementById('noOrders');
        const emptyCart = document.getElementById('emptyCart');
        const noCatalogProducts = document.getElementById('noCatalogProducts');

        // Búsqueda
        const adminProductSearch = document.getElementById('adminProductSearch');
        const quoteProductSearch = document.getElementById('quoteProductSearch');
        
        // Inputs Formulario Productos
        const productCostInput = document.getElementById('productCost');
        const productMarginInput = document.getElementById('productMargin');
        const productPricePublicOutput = document.getElementById('productPricePublic');

        // Inputs Formulario Pedido
        const orderKmInput = document.getElementById('orderKm');
        
        // Inputs de Configuración
        const shippingCostInput = document.getElementById('shippingCost');
        const storeNameInput = document.getElementById('storeName');
        const logoUrlInput = document.getElementById('logoUrl'); 
        const folioPrefixInput = document.getElementById('folioPrefix');
        const nextFolioInput = document.getElementById('nextFolio');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        
        // Estado de la App
        let userId = null;
        // Objeto de configuración (se carga desde Firebase)
        let appSettings = {
            storeName: 'MichiCatt Store',
            shippingCost: 23.99 / 7, // $3.427...
            folioPrefix: 'MC-S-',
            nextFolio: 1,
            logoUrl: '' 
        };
        let productsData = []; // Caché local de productos
        let orderCart = []; // Carrito de pedido
        let editingOrderId = null; // Para saber si estamos editando
        let editingProductId = null; // Para editar productos
        let ordersData = []; // Caché local de pedidos
        
        // Listeners (unsubscribers) de Firestore
        let productListener = null;
        let orderListener = null;
        let settingsListener = null;

        // Referencias a Colecciones de Firestore
        let productCollectionRef;
        let ordersCollectionRef;
        let settingsDocRef; 

        // ------------------------------------------------------------------
        // Lógica de Autenticación (¡MODIFICADA PARA AUTH REAL!)
        // ------------------------------------------------------------------

        // PASO 1: Observador de estado de Auth
        // Se dispara al cargar, al loguearse, y al desloguearse
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // --- Usuario está logueado ---
                console.log("Usuario logueado:", user.uid);
                userId = user.uid; // ¡El UID real del usuario!
                
                // Mostrar App y ocultar Login
                welcomeUser.textContent = `¡Hola, ${user.email.split('@')[0]}!`;
                loginScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                
                // Iniciar la app y cargar datos
                initializeAppLocal(userId);
                
            } else {
                // --- Usuario no está logueado ---
                console.log("Usuario deslogueado.");
                userId = null;
                
                // Ocultar App y mostrar Login
                loginScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
                
                // Detener listeners de datos para evitar errores
                cleanupListeners();
            }
        });

        // PASO 2: Manejador del formulario de Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            loginError.classList.add('hidden'); // Ocultar error previo

            try {
                // Intentar iniciar sesión
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged se encargará del resto
                
            } catch (error) {
                console.error("Error al iniciar sesión:", error.code);
                let message = "Error al iniciar sesión.";
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    message = "Email o contraseña incorrectos.";
                } else if (error.code === 'auth/invalid-email') {
                    message = "El formato del email es incorrecto.";
                }
                loginError.textContent = message;
                loginError.classList.remove('hidden');
            }
        });

        // PASO 3: Manejador de Cerrar Sesión
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // onAuthStateChanged se encargará de limpiar y mostrar login
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                showToast("Error al cerrar sesión", true);
            }
        });

        // ------------------------------------------------------------------
        // Inicialización de la App
        // ------------------------------------------------------------------
        
        function initializeAppLocal(uid) { 
            if (!uid) {
                console.error("¡Fallo de inicialización! No hay UID.");
                return;
            }
            
            // Limpiar listeners antiguos por si acaso (ej. re-login)
            cleanupListeners();
            
            initFirestoreRefs();
            initEventListeners();
            initDataListeners();
        }

        // ------------------------------------------------------------------
        // Inicialización de Firestore (¡RUTAS COMPARTIDAS!)
        // ------------------------------------------------------------------
        
        function initFirestoreRefs() {
            if (!userId) return;
            // ¡RUTAS CAMBIADAS! Ya no dependen de 'userId'
            productCollectionRef = collection(db, 'products');
            ordersCollectionRef = collection(db, 'orders');
            settingsDocRef = doc(db, 'config', 'main');
        }
        
        // ------------------------------------------------------------------
        // Lógica de Pestañas
        // ------------------------------------------------------------------
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Quitar clase activa de todos
                tabs.forEach(t => {
                    t.classList.remove('active-tab', 'text-pink-secondary', 'border-pink-primary');
                    t.classList.add('text-pink-dark/70', 'hover:text-pink-primary');
                });
                // Ocultar todo el contenido
                tabContents.forEach(c => c.classList.add('hidden'));

                // Activar la pestaña clicada
                tab.classList.add('active-tab', 'text-pink-secondary', 'border-pink-primary');
                tab.classList.remove('text-pink-dark/70', 'hover:text-pink-primary');
                // Mostrar el contenido correspondiente
                document.getElementById(tab.dataset.tab).classList.remove('hidden');
            });
        });

        // ------------------------------------------------------------------
        // Lógica de Toast (Notificación)
        // ------------------------------------------------------------------
        
        function showToast(message, isError = false) {
            toast.textContent = message;
            if (isError) {
                toast.classList.remove('bg-green-500');
                toast.classList.add('bg-red-500');
            } else {
                toast.classList.remove('bg-red-500');
                toast.classList.add('bg-green-500');
            }
            
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-10');
            }, 3000);
        }

        // ------------------------------------------------------------------
        // Lógica de Formateo
        // ------------------------------------------------------------------
        
        const formatCurrency = (value) => {
            return (value || 0).toLocaleString('es-MX', {
                style: 'currency',
                currency: 'MXN',
            });
        };
        
        // ------------------------------------------------------------------
        // Listeners de Eventos (Solo se registran una vez)
        // ------------------------------------------------------------------
        
        // Variable para asegurar que los listeners solo se añadan una vez
        let eventListenersInitialized = false;

        function initEventListeners() {
            if (eventListenersInitialized) return; // Prevenir duplicados
            
            // Formularios
            addProductForm.addEventListener('submit', onSaveProduct);
            
            // Botones
            saveOrderBtn.addEventListener('click', onSaveOrder);
            clearOrderBtn.addEventListener('click', handleClearOrderClick); 
            saveSettingsBtn.addEventListener('click', onSaveSettings); 
            productEditCancelBtn.addEventListener('click', cancelProductEdit); 
            
            // Búsqueda
            adminProductSearch.addEventListener('input', renderAdminProductsList);
            quoteProductSearch.addEventListener('input', renderQuoteCatalogList);
            
            // Clics en listas (Delegación de eventos)
            document.addEventListener('click', handleDocumentClick);

            // Calculadora de Precio de Producto
            productCostInput.addEventListener('input', updateCalculatedPrice);
            productMarginInput.addEventListener('input', updateCalculatedPrice);
            
            // Calculadora de Envío
            orderKmInput.addEventListener('input', updateOrderSummary);
            
            eventListenersInitialized = true;
        }

        // ------------------------------------------------------------------
        // Listeners de Datos (Firestore)
        // ------------------------------------------------------------------

        // Iniciar todos los listeners de Firestore
        function initDataListeners() {
            if (!userId) return;

            // Listener de Productos
            productListener = onSnapshot(query(productCollectionRef), (snapshot) => {
                productsData = [];
                
                if (snapshot.empty) {
                    noProducts.classList.remove('hidden');
                    noCatalogProducts.classList.remove('hidden');
                    productsList.innerHTML = '';
                    quoteCatalogList.innerHTML = '';
                } else {
                    noProducts.classList.add('hidden');
                    noCatalogProducts.classList.add('hidden');
                    snapshot.forEach(doc => {
                        productsData.push({ ...doc.data(), id: doc.id });
                    });
                    // Ordenar productos alfabéticamente
                    productsData.sort((a, b) => a.name.localeCompare(b.name));
                    
                    // Renderizar ambas listas
                    renderAdminProductsList();
                    renderQuoteCatalogList();
                }
            });

            // Listener de Pedidos Guardados
            orderListener = onSnapshot(query(ordersCollectionRef), (snapshot) => {
                ordersData = []; // Limpiar caché local
                if (snapshot.empty) {
                    noOrders.classList.remove('hidden');
                    ordersList.innerHTML = '';
                } else {
                    noOrders.classList.add('hidden');
                    const orderItems = [];
                    snapshot.forEach(doc => {
                        const order = { ...doc.data(), id: doc.id };
                        ordersData.push(order); // Guardar caché local
                        orderItems.push(renderOrderCard(order));
                    });
                    ordersList.innerHTML = orderItems.join('');
                }
            });
            
            // Listener de Configuración
            settingsListener = onSnapshot(settingsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    // Cargar configuración de Firebase
                    appSettings = { ...appSettings, ...docSnap.data() }; 
                } else {
                    // Si no existe, creamos el documento con los valores por defecto
                    setDoc(settingsDocRef, appSettings).catch(e => console.error("Error creating default settings:", e));
                }
                // Actualizar los inputs y UI
                shippingCostInput.value = appSettings.shippingCost.toFixed(4);
                storeNameInput.value = appSettings.storeName;
                folioPrefixInput.value = appSettings.folioPrefix;
                nextFolioInput.value = appSettings.nextFolio;
                logoUrlInput.value = appSettings.logoUrl; 
                
                // Actualizar UI
                document.title = appSettings.storeName;
                document.getElementById('appNameTitle').textContent = appSettings.storeName;
                
                // Actualizar Logos
                if (appSettings.logoUrl) {
                    logoImageLogin.src = appSettings.logoUrl;
                    logoImageHeader.src = appSettings.logoUrl;
                    logoImageLogin.classList.remove('hidden');
                    logoImageHeader.classList.remove('hidden');
                } else {
                    logoImageLogin.classList.add('hidden');
                    logoImageHeader.classList.add('hidden');
                }
                
                // Actualizar cálculo de envío por si cambió
                updateOrderSummary();
            });
        }
        
        // ¡NUEVO! Función para limpiar listeners al cerrar sesión
        function cleanupListeners() {
            if (productListener) productListener();
            if (orderListener) orderListener();
            if (settingsListener) settingsListener();
            
            productListener = null;
            orderListener = null;
            settingsListener = null;
            
            console.log("Listeners de Firestore detenidos.");
        }
        
        // ------------------------------------------------------------------
        // Manejador Global de Clics
        // ------------------------------------------------------------------
        
        async function handleDocumentClick(e) {
            // Clic en un producto del catálogo en Cotizador
            if (e.target.closest('.add-to-cart-btn')) {
                const item = e.target.closest('div[data-id]');
                const id = item.dataset.id;
                const product = productsData.find(p => p.id === id);
                if (product) {
                    addProductToCart(product);
                }
                return;
            }

            // Quitar item del carrito
            if (e.target.classList.contains('remove-cart-item')) {
                const item = e.target.closest('div[data-index]');
                if (item) {
                    const index = parseInt(item.dataset.index); 
                    orderCart.splice(index, 1);
                    renderOrderCart();
                    updateOrderSummary();
                }
                return;
            }
            
            // Clics en la lista de Productos del Admin
            const productItem = e.target.closest('#productsList div[data-id]');
            if (productItem) {
                const id = productItem.dataset.id;
                
                // Borrar Producto
                if (e.target.classList.contains('delete-product')) {
                    if (confirm("¿Estás segura de borrar este producto del catálogo?")) {
                        deleteDoc(doc(db, 'products', id))
                            .then(() => showToast("Producto eliminado"))
                            .catch(e => showToast("Error al eliminar", true));
                    }
                }
                
                // Editar Producto
                if (e.target.classList.contains('edit-product')) {
                    loadProductForEditing(id);
                }
                return;
            }

            // Acciones de Pedido (PDF, Eliminar, Editar)
            const orderCard = e.target.closest('#ordersList div[data-id]');
            if (orderCard) {
                const orderId = orderCard.dataset.id;
                
                // Botón de PDF
                if (e.target.classList.contains('download-order-pdf')) {
                    try {
                        const order = ordersData.find(o => o.id === orderId); // Usar caché local
                        if (order) {
                            generateOrderPDF(order);
                        }
                    } catch (error) { 
                        console.error("Error al generar PDF:", error);
                        showToast("Error al generar PDF", true); 
                    }
                }
                
                // Botón de Eliminar Pedido
                if (e.target.classList.contains('delete-order')) {
                    if (confirm("¿Estás segura de borrar este pedido? No se puede deshacer.")) {
                        deleteDoc(doc(db, 'orders', orderId))
                            .then(() => showToast("Pedido eliminado"))
                            .catch(e => showToast("Error al eliminar", true));
                    }
                }
                
                // Botón de Editar Pedido
                if (e.target.classList.contains('edit-order')) {
                    loadOrderForEditing(orderId);
                }
                return;
            }
        }

        // ------------------------------------------------------------------
        // Lógica de Pestaña PRODUCTOS
        // ------------------------------------------------------------------

        // --- Calcular Precio en Tiempo Real ---
        function updateCalculatedPrice() {
            const cost = parseFloat(productCostInput.value) || 0;
            const marginPercent = parseFloat(productMarginInput.value) || 0; // Es el % ej. 50

            if (cost === 0) {
                productPricePublicOutput.value = formatCurrency(0);
                return;
            }

            // ¡Validación importante!
            if (marginPercent >= 100) {
                productPricePublicOutput.value = "Error: Margen >= 100%";
                return;
            }
            
            const margin = marginPercent / 100; // Convertir 50 a 0.5
            
            // FÓRMULA DE MARGEN (Ganancia sobre Precio)
            const price = cost / (1 - margin); 
            
            productPricePublicOutput.value = formatCurrency(price);
        }

        // --- Guardar Producto ---
        async function onSaveProduct(e) {
            e.preventDefault();
            const name = document.getElementById('productName').value;
            const cost = parseFloat(productCostInput.value);
            const marginPercent = parseFloat(productMarginInput.value); 

            if (isNaN(cost) || isNaN(marginPercent)) {
                showToast("Costo y Margen deben ser números", true);
                return;
            }
            
            if (marginPercent >= 100) {
                showToast("El margen no puede ser 100% o más", true);
                return;
            }

            const margin = marginPercent / 100; // Convertir 50 a 0.5
            const price = cost / (1 - margin); 

            const productData = { 
                name, 
                cost, 
                margin: marginPercent, 
                price 
            };

            try {
                if (editingProductId) {
                    // --- MODO ACTUALIZACIÓN ---
                    await setDoc(doc(db, 'products', editingProductId), productData);
                    showToast("Producto actualizado");
                } else {
                    // --- MODO CREACIÓN ---
                    await addDoc(productCollectionRef, productData);
                    showToast("Producto guardado");
                }
                cancelProductEdit(); // Limpiar formulario y resetear modo
                
            } catch (error) {
                console.error("Error al guardar producto:", error);
                showToast("Error al guardar producto", true);
            }
        }
        
        // --- Cargar Producto para Editar ---
        function loadProductForEditing(id) {
            const product = productsData.find(p => p.id === id);
            if (!product) {
                showToast("No se encontró el producto", true);
                return;
            }
            
            // 1. Llenar el formulario
            document.getElementById('productName').value = product.name;
            productCostInput.value = product.cost;
            productMarginInput.value = product.margin;
            
            // 2. Actualizar estado
            editingProductId = id;
            updateCalculatedPrice(); // Calcular precio
            
            // 3. Cambiar UI del formulario
            saveProductBtn.textContent = "Actualizar Producto";
            productEditCancelBtn.classList.remove('hidden');
            
            // 4. Scroll al formulario
            addProductForm.scrollIntoView({ behavior: 'smooth' });
        }
        
        // --- Cancelar Edición de Producto ---
        function cancelProductEdit() {
            editingProductId = null;
            addProductForm.reset();
            productPricePublicOutput.value = "";
            saveProductBtn.textContent = "Guardar Producto";
            productEditCancelBtn.classList.add('hidden');
        }

        // --- Renderizar Lista (Admin) ---
        function renderAdminProductsList() {
            const searchTerm = adminProductSearch.value.toLowerCase();
            const filteredProducts = productsData.filter(p => p.name.toLowerCase().includes(searchTerm));
            
            if (filteredProducts.length === 0) {
                productsList.innerHTML = '<p class="text-pink-dark/60">No se encontraron productos.</p>';
                return;
            }

            productsList.innerHTML = filteredProducts.map(product => `
                <div class="border border-pink-100 p-3 rounded-lg flex justify-between items-center" data-id="${product.id}">
                    <div>
                        <p class="font-medium text-pink-dark">${product.name}</p>
                        <p class="text-sm text-pink-dark/70">
                            Público: ${formatCurrency(product.price)}
                        </p>
                    </div>
                    <div class="flex gap-2">
                        <button class="edit-product text-blue-500 hover:text-blue-700 font-semibold text-lg" title="Editar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 13H3V6.414l5-5L9.414 3 5 7.414V13zM15 17H5v-5l-2-2v7a2 2 0 002 2h10a2 2 0 002-2v-2l-2 2z"/></svg>
                        </button>
                        <button class="delete-product text-red-400 hover:text-red-600 font-bold text-lg" title="Eliminar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 3a1 1 0 011-1h6a1 1 0 011 1v2h2a1 1 0 011 1v1H3V6a1 1 0 011-1h2V3zM3 10v7a2 2 0 002 2h10a2 2 0 002-2v-7H3zm3 4a1 1 0 102 0v-4a1 1 0 10-2 0v4zm4 0a1 1 0 102 0v-4a1 1 0 10-2 0v4z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // ------------------------------------------------------------------
        // Lógica del COTIZADOR
        // ------------------------------------------------------------------
        
        // --- Renderizar Catálogo (Cotizador) ---
        function renderQuoteCatalogList() {
            const searchTerm = quoteProductSearch.value.toLowerCase();
            const filteredProducts = productsData.filter(p => p.name.toLowerCase().includes(searchTerm));
            
            if (filteredProducts.length === 0) {
                quoteCatalogList.innerHTML = '<p class="text-pink-dark/60">No se encontraron productos.</p>';
                return;
            }

            quoteCatalogList.innerHTML = filteredProducts.map(product => `
                <div class="catalog-item border border-pink-100 p-3 rounded-lg flex justify-between items-center cursor-pointer" data-id="${product.id}">
                    <div>
                        <p class="font-medium text-pink-dark pointer-events-none">${product.name}</p>
                        <p class="text-sm text-pink-dark/70 pointer-events-none">${formatCurrency(product.price)}</p>
                    </div>
                    <button class="add-to-cart-btn bg-pink-primary text-white text-xs px-3 py-1 rounded-full font-semibold hover:bg-pink-secondary transition-all">
                        Agregar
                    </button>
                </div>
            `).join('');
        }

        // --- Agregar Producto al Carrito ---
        function addProductToCart(product) {
            // Verificar si el producto ya está en el carrito
            const existingItem = orderCart.find(item => item.id === product.id);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                orderCart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                });
            }
            renderOrderCart();
            updateOrderSummary();
        }

        // --- Renderizar Carrito ---
        function renderOrderCart() {
            if (orderCart.length === 0) {
                emptyCart.classList.remove('hidden');
                orderCartItems.innerHTML = '';
                orderCartItems.appendChild(emptyCart);
                return;
            }

            emptyCart.classList.add('hidden');
            orderCartItems.innerHTML = orderCart.map((item, index) => `
                <div class="flex justify-between items-center py-2 border-b border-pink-100" data-index="${index}">
                    <div>
                        <p class="font-medium text-pink-dark">${item.name}</p>
                        <p class="text-sm text-pink-dark/70">${item.quantity} x ${formatCurrency(item.price)} = <strong>${formatCurrency(item.price * item.quantity)}</strong></p>
                    </div>
                    <button class="remove-cart-item text-red-400 hover:text-red-600 font-bold text-lg cursor-pointer">&times;</button>
                </div>
            `).join('');
        }

        // --- Actualizar Resumen de Pedido ---
        function updateOrderSummary() {
            const distance = parseFloat(orderKmInput.value) || 0;
            
            const subtotal = orderCart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            // ¡CORREGIDO! Usar appSettings.shippingCost
            const shipping = distance * appSettings.shippingCost;
            const total = subtotal + shipping;

            document.getElementById('orderSubtotal').textContent = formatCurrency(subtotal);
            document.getElementById('orderShipping').textContent = formatCurrency(shipping);
            document.getElementById('orderTotal').textContent = formatCurrency(total);
            
            return { subtotal, shipping, total, distance };
        }

        // --- Limpiar Pedido ---
        // 1. La función que SÍ limpia (sin preguntar)
        function clearOrderForm() {
            orderCart = [];
            editingOrderId = null; // ¡IMPORTANTE! Resetear modo edición
            // newOrderForm.reset(); // Esto da problemas, mejor manual
            document.getElementById('orderClientName').value = '';
            document.getElementById('orderKm').value = 0;
            renderOrderCart();
            updateOrderSummary();
            // Cambiar texto del botón a "Guardar"
            saveOrderBtn.textContent = "Guardar Pedido";
            saveOrderBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            saveOrderBtn.classList.add('bg-green-500', 'hover:bg-green-600');
        }
        
        // 2. El manejador del botón, que SÍ pregunta
        function handleClearOrderClick() {
            if (editingOrderId) {
                // Si estamos editando, "limpiar" es "cancelar"
                clearOrderForm();
            } else if (confirm("¿Estás segura de limpiar este pedido?")) {
                clearOrderForm();
            }
        }

        // --- Guardar Pedido ---
        async function onSaveOrder(e) {
            e.preventDefault();
            
            if (orderCart.length === 0) {
                showToast("El carrito está vacío", true);
                return;
            }
            const clientName = document.getElementById('orderClientName').value;
            if (!clientName) {
                showToast("Escribe el nombre del cliente", true);
                return;
            }

            const summary = updateOrderSummary();
            
            const orderData = {
                clientName: clientName,
                items: orderCart,
                ...summary,
            };

            try {
                if (editingOrderId) {
                    // --- MODO ACTUALIZACIÓN ---
                    // No actualizamos la fecha ni el folio, solo los datos
                    await setDoc(doc(db, 'orders', editingOrderId), orderData, { merge: true });
                    showToast("Pedido actualizado");
                } else {
                    // --- MODO CREACIÓN (NUEVO PEDIDO) ---
                    // Generar folio
                    const folioString = appSettings.folioPrefix + String(appSettings.nextFolio).padStart(4, '0');
                    orderData.folio = folioString;
                    orderData.createdAt = serverTimestamp();
                    
                    await addDoc(ordersCollectionRef, orderData);
                    
                    // Incrementar el folio en la config
                    const newNextFolio = appSettings.nextFolio + 1;
                    await setDoc(settingsDocRef, { nextFolio: newNextFolio }, { merge: true });
                    // appSettings.nextFolio se actualizará solo gracias al listener
                    
                    showToast("Pedido guardado");
                }
                
                clearOrderForm(); // Limpiar formulario (esto también resetea editingOrderId)

            } catch (error) {
                console.error("Error al guardar pedido:", error);
                showToast("Error al guardar pedido", true);
            }
        }
        
        // --- Cargar Pedido para Editar ---
        function loadOrderForEditing(orderId) {
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showToast("No se encontró el pedido", true);
                return;
            }
            
            // 1. Poner datos en el formulario
            editingOrderId = order.id;
            document.getElementById('orderClientName').value = order.clientName;
            document.getElementById('orderKm').value = order.distance;
            orderCart = JSON.parse(JSON.stringify(order.items)); // Copia profunda
            
            // 2. Actualizar UI del carrito
            renderOrderCart();
            updateOrderSummary();
            
            // 3. Cambiar botón a modo "Actualizar"
            saveOrderBtn.textContent = `Actualizar Pedido (${order.folio})`;
            saveOrderBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            saveOrderBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
            
            // 4. Cambiar a la pestaña del cotizador
            // Simulamos clic en la pestaña
            tabs.forEach(tab => {
                if (tab.dataset.tab === 'cotizador') {
                    tab.click();
                }
            });
            
            // 5. Scroll al inicio
            window.scrollTo(0, 0);
        }
        
        // ------------------------------------------------------------------
        // Lógica de Pestaña PEDIDOS GUARDADOS
        // ------------------------------------------------------------------

        function renderOrderCard(order) {
            const date = order.createdAt?.toDate ? order.createdAt.toDate().toLocaleDateString('es-MX') : 'Fecha N/D';
            
            const itemsHtml = order.items.map(item => `
                <li class="text-sm text-pink-dark/80">${item.quantity}x ${item.name} - ${formatCurrency(item.price * item.quantity)}</li>
            `).join('');

            return `
                <div class="bg-white p-5 rounded-2xl shadow-lg" data-id="${order.id}">
                    <div class="flex justify-between items-start">
                        <h3 class="font-bold text-lg text-pink-secondary">${order.clientName}</h3>
                        <span class="text-xs font-mono bg-pink-light text-pink-dark px-2 py-1 rounded-full">${order.folio || 'SIN-FOLIO'}</span>
                    </div>
                    <p class="text-sm text-pink-dark/60 mb-3">ID: ${order.id.substring(0, 6)} | ${date}</p>
                    
                    <ul class="list-disc list-inside space-y-1 my-3 pl-1">${itemsHtml}</ul>
                    
                    <div class="mt-4 pt-4 border-t border-pink-100 space-y-1">
                        <p class="flex justify-between text-sm"><span>Subtotal:</span> <span class="font-medium">${formatCurrency(order.subtotal)}</span></p>
                        <p class="flex justify-between text-sm"><span>Envío (${order.distance} km):</span> <span class="font-medium">${formatCurrency(order.shipping)}</span></p>
                        <p class="flex justify-between text-base font-bold text-pink-secondary"><span>Total:</span> <span>${formatCurrency(order.total)}</span></p>
                    </div>

                    <div class="mt-6 grid grid-cols-3 gap-2">
                        <button class="download-order-pdf w-full text-xs bg-blue-500 text-white py-2 px-2 rounded-lg font-semibold hover:bg-blue-600 transition-all" title="Descargar PDF">
                            PDF
                        </button>
                        <button class="edit-order w-full text-xs bg-yellow-500 text-white py-2 px-2 rounded-lg font-semibold hover:bg-yellow-600 transition-all" title="Editar">
                            Editar
                        </button>
                        <button class="delete-order w-full text-xs bg-red-500 text-white py-2 px-2 rounded-lg font-semibold hover:bg-red-600 transition-all" title="Eliminar">
                            Eliminar
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ------------------------------------------------------------------
        // Lógica de Generación de PDF
        // ------------------------------------------------------------------
        
        function getBasePDF(title) {
            // Se inicializa aquí para asegurar que la librería esté cargada
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF();
            doc.setFont("helvetica", "normal");
            
            // Encabezado
            doc.setFontSize(22);
            doc.setTextColor(236, 72, 153); // Color 'pink-secondary'
            doc.text(appSettings.storeName, 20, 20); // Usar nombre de la tienda
            
            doc.setFontSize(10);
            doc.setTextColor(131, 24, 67); // Color 'pink-dark'
            doc.text("Reporte de Venta", 20, 28);
            
            doc.setFontSize(14);
            doc.setTextColor(40, 40, 40);
            doc.text(title, 190, 20, { align: 'right' });
            
            return doc;
        }

        // --- Generar PDF de Pedido ---
        function generateOrderPDF(order) {
            const doc = getBasePDF("Resumen de Pedido");
            const date = order.createdAt?.toDate ? order.createdAt.toDate().toLocaleDateString('es-MX') : 'Fecha N/D';
            
            doc.setFontSize(10);
            doc.text(`ID: ${order.id}`, 190, 26, { align: 'right' });
            doc.text(`Fecha: ${date}`, 190, 31, { align: 'right' });
            doc.setFont("helvetica", "bold");
            doc.text(`Folio: ${order.folio || 'N/A'}`, 190, 36, { align: 'right' });

            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            
            // Nombre del Cliente
            doc.setFont("helvetica", "bold");
            doc.text("Cliente:", 20, 45);
            doc.setFont("helvetica", "normal");
            doc.text(order.clientName, 40, 45);
            
            const tableColumn = ["Cant.", "Producto", "Precio Unit.", "Total"];
            const tableRows = order.items.map(item => [
                item.quantity,
                item.name,
                formatCurrency(item.price),
                formatCurrency(item.price * item.quantity)
            ]);
            doc.autoTable(tableColumn, tableRows, { 
                startY: 65,
                theme: 'striped',
                headStyles: { fillColor: [236, 72, 153] },
            });
            
            const finalY = doc.autoTable.previous.finalY;
            doc.setFontSize(12);
            
            doc.text("Subtotal:", 140, finalY + 10);
            doc.text(formatCurrency(order.subtotal), 190, finalY + 10, { align: 'right' });
            doc.text(`Envío (${order.distance} km):`, 140, finalY + 17);
            doc.text(formatCurrency(order.shipping), 190, finalY + 17, { align: 'right' });

            doc.setFont("helvetica", "bold");
            doc.text("Total Pedido:", 140, finalY + 24);
            doc.text(formatCurrency(order.total), 190, finalY + 24, { align: 'right' });

            doc.save(`Pedido_${order.clientName}_${order.id.substring(0,6)}.pdf`);
        }

        // --- Guardar Ajustes de Configuración ---
        async function onSaveSettings(e) {
            e.preventDefault();
            // Recolectar todos los nuevos datos
            const newCost = parseFloat(shippingCostInput.value);
            const newName = storeNameInput.value.trim();
            const newPrefix = folioPrefixInput.value;
            const newNextFolio = parseInt(nextFolioInput.value);
            const newLogoUrl = logoUrlInput.value.trim();
            
            if (isNaN(newCost) || newCost < 0) {
                showToast("El costo por KM debe ser un número positivo", true); return;
            }
            if (!newName) {
                showToast("El nombre de la tienda no puede estar vacío", true); return;
            }
            if (isNaN(newNextFolio) || newNextFolio < 1) {
                showToast("El próximo folio debe ser un número mayor a 0", true); return;
            }

            const newSettings = {
                shippingCost: newCost,
                storeName: newName,
                folioPrefix: newPrefix,
                nextFolio: newNextFolio,
                logoUrl: newLogoUrl
            };

            try {
                // Usamos setDoc para sobreescribir (o crear)
                await setDoc(settingsDocRef, newSettings);
                appSettings = newSettings; // Actualiza el estado local
                showToast("Ajustes guardados");
            } catch (error) {
                console.error("Error al guardar ajustes:", error);
                showToast("Error al guardar ajustes", true);
            }
        }

    </script>
</body>
</html>
